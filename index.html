<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบจองที่นั่งเรียน</title>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #1a73e8;
            --primary-dark: #0d47a1;
            --success: #34a853;
            --success-light: #81c995;
            --warning: #fbbc04;
            --booked: #000000;
            --reserving: #ff6b35;
            --reserving-light: #ff9c7a;
            --gray: #5f6368;
            --light-gray: #f5f7fa;
            --error: #ea4335;
            --art: #9c27b0;
            --ball: #4caf50;
            --cn: #f44336;
            --com: #2196f3;
            --dance: #ff9800;
            --food: #795548;
            --music: #3f51b5;
            --music-th: #009688;
            --swim: #00bcd4;
            --craft: #607d8b;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--light-gray);
            color: #333;
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            position: relative;
        }

        header {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            padding: 20px 30px;
            text-align: center;
            position: relative;
        }

        header h1 {
            margin-bottom: 10px;
            font-size: 2.2rem;
        }

        .admin-link {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.2);
            padding: 8px 15px;
            border-radius: 5px;
            color: white;
            text-decoration: none;
            font-size: 0.9rem;
            transition: all 0.3s;
            border: 1px solid rgba(255, 255, 255, 0.3);
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .admin-link:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
            text-decoration: none;
            color: white;
        }

        .nav-tabs {
            display: flex;
            background-color: #f1f3f4;
            border-bottom: 1px solid #ddd;
        }

        .tab-button {
            flex: 1;
            padding: 15px;
            background: none;
            border: none;
            font-size: 1rem;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .tab-button:hover {
            background-color: #e8f0fe;
        }

        .tab-button.active {
            background-color: white;
            border-bottom: 3px solid var(--primary);
            font-weight: bold;
            color: var(--primary);
        }

        .tab-content {
            padding: 30px;
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* ปุ่มหมวดหมู่ */
        .category-container {
            margin: 20px 0;
            overflow-x: auto;
            padding-bottom: 10px;
        }

        .category-buttons {
            display: flex;
            flex-wrap: nowrap;
            gap: 10px;
            padding: 10px 0;
        }

        .category-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-width: 80px;
            padding: 12px 8px;
            border: none;
            border-radius: 8px;
            background-color: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
            text-align: center;
        }

        .category-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        .category-btn.active {
            transform: translateY(-3px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .category-icon {
            font-size: 1.5rem;
            margin-bottom: 5px;
        }

        .category-text {
            font-size: 0.85rem;
        }

        /* สีสำหรับแต่ละหมวดหมู่ */
        .category-art { background-color: rgba(156, 39, 176, 0.1); border-left: 4px solid var(--art); color: var(--art); }
        .category-art.active { background-color: rgba(156, 39, 176, 0.2); }
        .category-ball { background-color: rgba(76, 175, 80, 0.1); border-left: 4px solid var(--ball); color: var(--ball); }
        .category-ball.active { background-color: rgba(76, 175, 80, 0.2); }
        .category-cn { background-color: rgba(244, 67, 54, 0.1); border-left: 4px solid var(--cn); color: var(--cn); }
        .category-cn.active { background-color: rgba(244, 67, 54, 0.2); }
        .category-com { background-color: rgba(33, 150, 243, 0.1); border-left: 4px solid var(--com); color: var(--com); }
        .category-com.active { background-color: rgba(33, 150, 243, 0.2); }
        .category-dance { background-color: rgba(255, 152, 0, 0.1); border-left: 4px solid var(--dance); color: var(--dance); }
        .category-dance.active { background-color: rgba(255, 152, 0, 0.2); }
        .category-food { background-color: rgba(121, 85, 72, 0.1); border-left: 4px solid var(--food); color: var(--food); }
        .category-food.active { background-color: rgba(121, 85, 72, 0.2); }
        .category-music { background-color: rgba(63, 81, 181, 0.1); border-left: 4px solid var(--music); color: var(--music); }
        .category-music.active { background-color: rgba(63, 81, 181, 0.2); }
        .category-music-th { background-color: rgba(0, 150, 136, 0.1); border-left: 4px solid var(--music-th); color: var(--music-th); }
        .category-music-th.active { background-color: rgba(0, 150, 136, 0.2); }
        .category-swim { background-color: rgba(0, 188, 212, 0.1); border-left: 4px solid var(--swim); color: var(--swim); }
        .category-swim.active { background-color: rgba(0, 188, 212, 0.2); }
        .category-craft { background-color: rgba(96, 125, 139, 0.1); border-left: 4px solid var(--craft); color: var(--craft); }
        .category-craft.active { background-color: rgba(96, 125, 139, 0.2); }
        .category-all { background-color: rgba(26, 115, 232, 0.1); border-left: 4px solid var(--primary); color: var(--primary); }
        .category-all.active { background-color: rgba(26, 115, 232, 0.2); }

        /* กล่องแสดงรายการวิชา */
        .category-info {
            background: linear-gradient(135deg, #f8f9fa, #e8f0fe);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        .category-info h3 {
            color: var(--primary);
            margin: 0;
            font-size: 1.2rem;
        }

        .course-count {
            background: var(--primary);
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: bold;
        }

        .courses-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .course-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            transition: transform 0.3s, box-shadow 0.3s;
            background-color: white;
            position: relative;
            overflow: hidden;
        }

        .course-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 5px;
            height: 100%;
            background: var(--primary);
        }

        .course-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }

        .course-card h3 {
            color: var(--primary);
            margin-bottom: 10px;
            font-size: 1.3rem;
        }

        .course-card p {
            margin-bottom: 8px;
            color: #666;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .course-card p i {
            width: 20px;
            color: var(--gray);
        }

        .seat-progress {
            margin: 15px 0;
            height: 8px;
            background: #f0f0f0;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            transition: width 0.5s;
        }

        .seat-info {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
            font-weight: bold;
            font-size: 0.95rem;
        }

        .available {
            color: var(--primary);
        }

        .booked {
            color: var(--booked);
        }

        .reserving {
            color: var(--reserving);
        }

        .btn {
            display: inline-block;
            padding: 10px 20px;
            background-color: var(--primary);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            text-decoration: none;
            transition: all 0.3s;
            margin-top: 10px;
            width: 100%;
            text-align: center;
        }

        .btn:hover {
            background-color: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .btn-secondary {
            background-color: var(--gray);
        }

        .btn-secondary:hover {
            background-color: #4a4d52;
        }

        .btn-success {
            background-color: var(--success);
        }

        .btn-success:hover {
            background-color: #2e8b47;
        }

        .btn-danger {
            background-color: var(--booked);
            color: white;
        }

        .btn-danger:hover {
            background-color: #333333;
        }

        .btn-error {
            background-color: var(--error);
        }

        .btn-error:hover {
            background-color: #c23325;
        }

        .booking-container {
            display: flex;
            flex-wrap: wrap;
            gap: 30px;
        }

        .seats-section {
            flex: 2;
            min-width: 300px;
        }

        .info-section {
            flex: 1;
            min-width: 250px;
        }

        .screen {
            background: linear-gradient(to right, #333, #555);
            color: white;
            text-align: center;
            padding: 15px;
            margin-bottom: 30px;
            border-radius: 5px;
            font-weight: bold;
            letter-spacing: 3px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .seats-grid {
            display: grid;
            grid-template-columns: repeat(10, 1fr);
            gap: 8px;
            margin-bottom: 30px;
        }

        .seat {
            width: 40px;
            height: 40px;
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.2s;
            user-select: none;
            position: relative;
        }

        .seat::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            opacity: 0;
            transition: opacity 0.2s;
        }

        .seat:hover::after {
            opacity: 1;
        }

        .seat:hover {
            transform: scale(1.1);
        }

        .seat-available {
            background-color: var(--primary);
            color: white;
        }

        .seat-selected {
            background-color: var(--success);
            color: white;
            animation: greenPulse 2s infinite;
            box-shadow: 0 0 10px rgba(52, 168, 83, 0.5);
        }

        @keyframes greenPulse {
            0% { 
                background-color: var(--success);
                box-shadow: 0 0 5px rgba(52, 168, 83, 0.5);
            }
            50% { 
                background-color: var(--success-light);
                box-shadow: 0 0 15px rgba(52, 168, 83, 0.8);
            }
            100% { 
                background-color: var(--success);
                box-shadow: 0 0 5px rgba(52, 168, 83, 0.5);
            }
        }

        .seat-reserving {
            background-color: var(--reserving);
            color: white;
            animation: reservingPulse 1.5s infinite;
            box-shadow: 0 0 8px rgba(255, 107, 53, 0.6);
        }

        @keyframes reservingPulse {
            0% { 
                background-color: var(--reserving);
                box-shadow: 0 0 5px rgba(255, 107, 53, 0.6);
            }
            50% { 
                background-color: var(--reserving-light);
                box-shadow: 0 0 15px rgba(255, 107, 53, 0.8);
            }
            100% { 
                background-color: var(--reserving);
                box-shadow: 0 0 5px rgba(255, 107, 53, 0.6);
            }
        }

        .seat-booked {
            background-color: var(--booked);
            color: white;
            cursor: not-allowed;
            opacity: 0.9;
        }

        .seat-legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 5px 10px;
            background: #f8f9fa;
            border-radius: 5px;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 3px;
        }

        .booking-form {
            background-color: #f8f9fa;
            padding: 25px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .booking-form h3 {
            color: var(--primary);
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--primary);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #444;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        .form-group input:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 3px rgba(26, 115, 232, 0.1);
        }

        .input-hint {
            font-size: 0.85rem;
            color: #666;
            margin-top: 5px;
            font-style: italic;
        }

        .selected-seats {
            padding: 15px;
            background: #e8f4ea;
            border-radius: 5px;
            min-height: 50px;
            border: 2px dashed var(--success);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: var(--success);
            transition: all 0.3s;
        }

        .booking-info {
            background: linear-gradient(135deg, #f8f9fa, #e8f0fe);
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .booking-info h3 {
            color: var(--primary);
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--primary);
        }

        .booking-info p {
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .booking-info strong {
            color: #444;
            min-width: 120px;
        }

        .booking-info span {
            color: var(--primary);
            font-weight: bold;
        }

        footer {
            text-align: center;
            padding: 20px;
            color: #666;
            font-size: 0.9rem;
            border-top: 1px solid #eee;
            margin-top: 30px;
            background: #f8f9fa;
        }

        .footer-links {
            margin-top: 10px;
            display: flex;
            justify-content: center;
            gap: 20px;
        }

        .footer-links a {
            color: var(--primary);
            text-decoration: none;
            font-size: 0.85rem;
            transition: color 0.3s;
        }

        .footer-links a:hover {
            color: var(--primary-dark);
            text-decoration: underline;
        }

        .connection-status {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            margin-top: 10px;
        }

        .connection-status.connected {
            background: #e6f4ea;
            color: var(--success);
        }

        .connection-status.disconnected {
            background: #fdecea;
            color: var(--booked);
        }

        .connection-status.connecting {
            background: #fef7e0;
            color: var(--warning);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            animation: slideUp 0.3s;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal h2 {
            margin-bottom: 20px;
            color: var(--primary);
        }

        .close-modal {
            float: right;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
            transition: color 0.3s;
        }

        .close-modal:hover {
            color: var(--booked);
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .empty-state {
            grid-column: 1 / -1;
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .empty-state i {
            font-size: 4rem;
            margin-bottom: 20px;
            color: #ddd;
        }

        .btn-disabled {
            background-color: #cccccc !important;
            color: #666666 !important;
            cursor: not-allowed !important;
            transform: none !important;
            box-shadow: none !important;
        }

        .reservation-timeout {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            margin-top: 10px;
            background: #e8f4ea;
            color: var(--success);
        }

        .confirmation-box {
            background: #e8f4ea;
            border: 2px solid var(--success);
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            display: none;
        }

        .confirmation-box.active {
            display: block;
        }

        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--reserving);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .seat-reservation-info {
            background: #fff8e6;
            border: 2px solid var(--warning);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            display: none;
        }

        .seat-reservation-info.active {
            display: block;
        }

        .error-box {
            background: #fdecea;
            border: 2px solid var(--error);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            display: none;
        }

        .error-box.active {
            display: block;
        }

        @media (max-width: 768px) {
            .seats-grid {
                grid-template-columns: repeat(5, 1fr);
            }
            
            .booking-container {
                flex-direction: column;
            }
            
            .admin-link {
                position: static;
                display: inline-block;
                margin-top: 10px;
            }
            
            .legend-item {
                padding: 3px 6px;
                font-size: 0.9rem;
            }
            
            .category-buttons {
                flex-wrap: nowrap;
                overflow-x: auto;
            }
            
            .category-btn {
                min-width: 70px;
                padding: 10px 6px;
            }
            
            .category-icon {
                font-size: 1.2rem;
            }
            
            .category-text {
                font-size: 0.75rem;
            }
        }

        @media (max-width: 480px) {
            .seats-grid {
                grid-template-columns: repeat(4, 1fr);
                gap: 5px;
            }
            
            .seat {
                width: 35px;
                height: 35px;
                font-size: 0.9rem;
            }
            
            .courses-grid {
                grid-template-columns: 1fr;
            }
            
            .category-buttons {
                gap: 5px;
            }
            
            .category-btn {
                min-width: 60px;
                padding: 8px 4px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-chair"></i> ระบบจองที่นั่งเรียน</h1>
            <p>มหาวิทยาลัยเทคโนโลยีแห่งการเรียนรู้</p>
            <a href="admin.html" class="admin-link" id="admin-access-link">
                <i class="fas fa-user-shield"></i> ผู้ดูแลระบบ
            </a>
        </header>

        <div class="nav-tabs">
            <button class="tab-button active" data-tab="home">หน้าหลัก</button>
            <button class="tab-button" data-tab="booking" id="booking-tab" disabled>จองที่นั่ง</button>
            <!-- ลบแท็บ "วิธีใช้" ออกแล้ว -->
        </div>

        <!-- หน้าหลัก -->
        <div id="home" class="tab-content active">
            <h2><i class="fas fa-book-open"></i> เลือกรายวิชา</h2>
            <p>เลือกหมวดหมู่วิชาที่ต้องการจองที่นั่งเรียน ข้อมูลจะอัพเดตแบบเรียลไทม์</p>
            
            <div class="connection-status connecting" id="connection-status">
                <i class="fas fa-circle"></i>
                <span>กำลังเชื่อมต่อกับฐานข้อมูล...</span>
            </div>
            
            <!-- แถวปุ่มหมวดหมู่ -->
            <div class="category-container">
                <div class="category-buttons" id="category-buttons">
                    <!-- ปุ่มหมวดหมู่จะถูกสร้างโดย JavaScript -->
                </div>
            </div>
            
            <!-- ข้อมูลหมวดหมู่ที่เลือก -->
            <div class="category-info" id="category-info" style="display: none;">
                <h3 id="current-category-name">หมวดหมู่ทั้งหมด</h3>
                <div class="course-count" id="course-count">0 วิชา</div>
            </div>
            
            <!-- รายการวิชา -->
            <div id="courses-list" class="courses-grid">
                <!-- วิชาจะแสดงที่นี่ -->
            </div>
        </div>

        <!-- จองที่นั่ง -->
        <div id="booking" class="tab-content">
            <h2>จองที่นั่งเรียน: <span id="course-name"></span></h2>
            <p id="course-description"></p>
            
            <!-- แจ้งเตือนเมื่อมีคนกำลังเลือกที่นั่ง -->
            <div class="seat-reservation-info" id="seat-reservation-info">
                <h4><i class="fas fa-exclamation-triangle" style="color: var(--warning);"></i> มีผู้อื่นกำลังเลือกที่นั่งอยู่ในขณะนี้</h4>
                <p id="reservation-details">กรุณารอสักครู่ก่อนเลือกที่นั่ง</p>
            </div>
            
            <!-- ข้อความแสดงข้อผิดพลาด -->
            <div class="error-box" id="error-box">
                <h4><i class="fas fa-exclamation-circle" style="color: var(--error);"></i> เกิดข้อผิดพลาด</h4>
                <p id="error-details"></p>
            </div>
            
            <div class="booking-container">
                <div class="seats-section">
                    <div class="screen">หน้าห้องเรียน</div>
                    <div class="seats-grid" id="seats-container">
                        <!-- ที่นั่งจะแสดงที่นี่ -->
                    </div>
                    
                    <div class="seat-legend">
                        <div class="legend-item">
                            <div class="legend-color seat-available"></div>
                            <span>ว่าง (คลิกเพื่อเลือก)</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color seat-selected"></div>
                            <span>กำลังเลือก (คลิกซ้ำเพื่อยกเลิก)</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color seat-reserving"></div>
                            <span>กำลังถูกเลือกโดยผู้อื่น</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color seat-booked"></div>
                            <span>จองแล้ว</span>
                        </div>
                    </div>
                    
                    <div class="reservation-timeout" id="reservation-timeout" style="display: none;">
                        <i class="fas fa-clock"></i>
                        <span>การจองที่นั่งจะหมดอายุใน <span id="timeout-countdown">30</span> วินาที</span>
                    </div>
                </div>
                
                <div class="info-section">
                    <div class="booking-form">
                        <h3><i class="fas fa-user"></i> ข้อมูลการจอง</h3>
                        <div class="form-group">
                            <label for="student-name"><i class="fas fa-user-circle"></i> ชื่อ-นามสกุล *</label>
                            <input type="text" id="student-name" placeholder="กรุณากรอกชื่อ-นามสกุล" required>
                        </div>
                        <div class="form-group">
                            <label for="student-class"><i class="fas fa-school"></i> ห้องเรียน *</label>
                            <input type="text" id="student-class" placeholder="ตัวอย่าง: ป.1/1, ม.3/2" required>
                            <div class="input-hint">กรอกห้องเรียนของคุณ เช่น ป.1/1, ม.3/2, อ.2, ห้อง 101</div>
                        </div>
                        <div class="form-group">
                            <label><i class="fas fa-chair"></i> ที่นั่งที่เลือก:</label>
                            <div class="selected-seats" id="selected-seats-display">
                                ยังไม่มีการเลือกที่นั่ง
                            </div>
                        </div>
                        
                        <div class="confirmation-box" id="confirmation-box">
                            <h4><i class="fas fa-check-circle" style="color: var(--success);"></i> ยืนยันการจอง</h4>
                            <p>กรุณายืนยันการจองภายใน 30 วินาที</p>
                            <p>การจองจะถูกยกเลิกอัตโนมัติหลังจากหมดเวลา</p>
                        </div>
                        
                        <button class="btn btn-success" id="confirm-booking">
                            <i class="fas fa-check-circle"></i> ยืนยันการจอง
                        </button>
                        <button class="btn btn-secondary" id="back-to-courses">
                            <i class="fas fa-arrow-left"></i> กลับหน้าแรก
                        </button>
                        <button class="btn btn-error" id="btn-debug" style="display: none;">
                            <i class="fas fa-bug"></i> แก้ไขปัญหา
                        </button>
                    </div>
                    
                    <div class="booking-info">
                        <h3><i class="fas fa-info-circle"></i> ข้อมูลวิชา</h3>
                        <p><strong><i class="fas fa-code"></i> รหัสวิชา:</strong> <span id="course-code"></span></p>
                        <p><strong><i class="fas fa-chalkboard-teacher"></i> อาจารย์:</strong> <span id="course-instructor"></span></p>
                        <p><strong><i class="fas fa-clock"></i> เวลาเรียน:</strong> <span id="course-time"></span></p>
                        <p><strong><i class="fas fa-chair"></i> จำนวนที่นั่ง:</strong> 
                            <span id="available-seats-count">0</span> / <span id="total-seats-count">0</span>
                        </p>
                        <p><strong><i class="fas fa-history"></i> อัพเดตล่าสุด:</strong> <span id="last-update">-</span></p>
                        <p><strong><i class="fas fa-users"></i> ผู้ใช้งานขณะนี้:</strong> <span id="active-users">0</span> คน</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- ลบหน้า "วิธีใช้" ออกแล้ว -->

        <footer>
            <p>ระบบจองที่นั่งเรียน &copy; 2023 - พัฒนาด้วย Firebase</p>
            <div class="footer-links">
                <a href="./"><i class="fas fa-home"></i> หน้าหลัก</a>
                <a href="admin.html" id="footer-admin-link"><i class="fas fa-user-shield"></i> ผู้ดูแล</a>
                <!-- ลบลิงก์ "วิธีใช้" ออกแล้ว -->
            </div>
        </footer>
    </div>

    <!-- Modal แสดงข้อความ -->
    <div id="message-modal" class="modal">
        <div class="modal-content">
            <span class="close-modal" id="close-message">&times;</span>
            <h2 id="message-title">ข้อความ</h2>
            <p id="message-text"></p>
            <button class="btn" id="btn-close-message" style="margin-top: 20px;">ตกลง</button>
        </div>
    </div>

    <!-- Loading Modal -->
    <div id="loading-modal" class="modal">
        <div class="modal-content" style="text-align: center;">
            <div class="loading" style="width: 40px; height: 40px; margin: 20px auto;"></div>
            <h3>กำลังดำเนินการ...</h3>
            <p id="loading-text">กำลังตรวจสอบที่นั่งและบันทึกข้อมูล</p>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAIawhBmDnJs2rfAoThFFG-8llvIk1--aU",
            authDomain: "exam-test-ac-me.firebaseapp.com",
            projectId: "exam-test-ac-me",
            storageBucket: "exam-test-ac-me.firebasestorage.app",
            messagingSenderId: "1064778433498",
            appId: "1:1064778433498:web:b57dd308fd48fdc57b76e3"
        };

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore(app);
        
        // Enable debug mode if URL has ?debug=1
        const urlParams = new URLSearchParams(window.location.search);
        const debugMode = urlParams.get('debug') === '1';
        
        if (debugMode) {
            console.log("Debug mode enabled");
            document.getElementById('btn-debug').style.display = 'inline-block';
        }

        // Global Variables
        let selectedCourse = null;
        let selectedSeats = [];
        let courses = {};
        let bookings = {};
        let seatReservations = {};
        let isConnected = false;
        let lastUpdateTime = null;
        let isProcessingBooking = false;
        let reservationTimeout = null;
        let reservationTimer = null;
        let seatReservationsListener = null;
        let activeUsers = 0;
        let currentCategory = 'all'; // หมวดหมู่ที่เลือกปัจจุบัน
        const RESERVATION_TIMEOUT_SECONDS = 30;
        const CLEANUP_INTERVAL = 5000; // 5 seconds
        
        // กำหนดหมวดหมู่วิชา
        const categories = [
            { id: 'all', name: 'ทั้งหมด', icon: 'fas fa-list', colorClass: 'category-all' },
            { id: 'ART', name: 'ศิลปะ', icon: 'fas fa-palette', colorClass: 'category-art' },
            { id: 'BALL', name: 'ฟุตซอล', icon: 'fas fa-futbol', colorClass: 'category-ball' },
            { id: 'CN', name: 'ภาษาจีน', icon: 'fas fa-language', colorClass: 'category-cn' },
            { id: 'COM', name: 'คอมพิวเตอร์', icon: 'fas fa-laptop-code', colorClass: 'category-com' },
            { id: 'D', name: 'นาฏศิลป์', icon: 'fas fa-theater-masks', colorClass: 'category-dance' },
            { id: 'FOOD', name: 'คหกรรม', icon: 'fas fa-utensils', colorClass: 'category-food' },
            { id: 'MUSIC', name: 'ดนตรีสากล', icon: 'fas fa-music', colorClass: 'category-music' },
            { id: 'MUSIC-T', name: 'ดนตรีไทย', icon: 'fas fa-guitar', colorClass: 'category-music-th' },
            { id: 'SWIM', name: 'ว่ายน้ำ', icon: 'fas fa-swimmer', colorClass: 'category-swim' },
            { id: 'W', name: 'งานประดิษฐ์', icon: 'fas fa-tools', colorClass: 'category-craft' }
        ];

        // DOM Elements
        const tabButtons = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('.tab-content');
        const coursesList = document.getElementById('courses-list');
        const bookingTab = document.getElementById('booking-tab');
        const seatsContainer = document.getElementById('seats-container');
        const courseNameElement = document.getElementById('course-name');
        const courseDescriptionElement = document.getElementById('course-description');
        const courseCodeElement = document.getElementById('course-code');
        const courseInstructorElement = document.getElementById('course-instructor');
        const courseTimeElement = document.getElementById('course-time');
        const availableSeatsCountElement = document.getElementById('available-seats-count');
        const totalSeatsCountElement = document.getElementById('total-seats-count');
        const selectedSeatsDisplay = document.getElementById('selected-seats-display');
        const confirmBookingBtn = document.getElementById('confirm-booking');
        const backToCoursesBtn = document.getElementById('back-to-courses');
        const studentNameInput = document.getElementById('student-name');
        const studentClassInput = document.getElementById('student-class');
        const connectionStatus = document.getElementById('connection-status');
        const lastUpdateElement = document.getElementById('last-update');
        const messageModal = document.getElementById('message-modal');
        const loadingModal = document.getElementById('loading-modal');
        const reservationTimeoutElement = document.getElementById('reservation-timeout');
        const timeoutCountdownElement = document.getElementById('timeout-countdown');
        const confirmationBox = document.getElementById('confirmation-box');
        const seatReservationInfo = document.getElementById('seat-reservation-info');
        const reservationDetails = document.getElementById('reservation-details');
        const activeUsersElement = document.getElementById('active-users');
        const adminAccessLink = document.getElementById('admin-access-link');
        const footerAdminLink = document.getElementById('footer-admin-link');
        const messageTitle = document.getElementById('message-title');
        const messageText = document.getElementById('message-text');
        const loadingText = document.getElementById('loading-text');
        const closeMessageBtn = document.getElementById('close-message');
        const btnCloseMessage = document.getElementById('btn-close-message');
        const errorBox = document.getElementById('error-box');
        const errorDetails = document.getElementById('error-details');
        const btnDebug = document.getElementById('btn-debug');
        const categoryButtonsContainer = document.getElementById('category-buttons');
        const categoryInfo = document.getElementById('category-info');
        const currentCategoryName = document.getElementById('current-category-name');
        const courseCountElement = document.getElementById('course-count');

        // Event Listeners
        document.addEventListener('DOMContentLoaded', initializeApp);
        
        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                const tabId = button.getAttribute('data-tab');
                openTab(tabId);
            });
        });

        backToCoursesBtn.addEventListener('click', () => {
            clearReservation();
            openTab('home');
        });
        
        confirmBookingBtn.addEventListener('click', confirmBooking);
        closeMessageBtn.addEventListener('click', closeMessage);
        btnCloseMessage.addEventListener('click', closeMessage);
        btnDebug.addEventListener('click', showDebugInfo);

        // Initialize App
        async function initializeApp() {
            updateConnectionStatus('กำลังเชื่อมต่อกับฐานข้อมูล...', 'connecting');
            
            try {
                // Test Firebase connection
                const testRef = db.collection('test_connection');
                await testRef.add({
                    timestamp: new Date().toISOString(),
                    test: true
                });
                
                updateConnectionStatus('เชื่อมต่อกับฐานข้อมูลสำเร็จ', 'connected');
                isConnected = true;
                
                // สร้างปุ่มหมวดหมู่
                createCategoryButtons();
                
                // โหลดข้อมูลวิชาทั้งหมด (เบื้องต้น)
                await loadCoursesInitial();
                
                // Start cleanup interval
                setInterval(cleanupExpiredReservations, CLEANUP_INTERVAL);
                
            } catch (error) {
                console.error("Connection error:", error);
                updateConnectionStatus('เชื่อมต่อกับฐานข้อมูลล้มเหลว', 'disconnected');
                isConnected = false;
                
                // Show detailed error
                showError('การเชื่อมต่อล้มเหลว', 
                    'ไม่สามารถเชื่อมต่อกับฐานข้อมูลได้\n\n' +
                    'สาเหตุ: ' + error.message + '\n\n' +
                    'กรุณาตรวจสอบ:\n' +
                    '1. การเชื่อมต่ออินเทอร์เน็ต\n' +
                    '2. Firebase Project Configuration'
                );
            }
        }

        // สร้างปุ่มหมวดหมู่
        function createCategoryButtons() {
            if (!categoryButtonsContainer) return;
            
            categories.forEach(category => {
                const button = document.createElement('button');
                button.className = `category-btn ${category.colorClass}`;
                button.setAttribute('data-category', category.id);
                
                if (category.id === currentCategory) {
                    button.classList.add('active');
                }
                
                button.innerHTML = `
                    <div class="category-icon">
                        <i class="${category.icon}"></i>
                    </div>
                    <div class="category-text">${category.name}</div>
                `;
                
                button.addEventListener('click', () => {
                    selectCategory(category.id);
                });
                
                categoryButtonsContainer.appendChild(button);
            });
        }

        // เลือกหมวดหมู่
        function selectCategory(categoryId) {
            currentCategory = categoryId;
            
            // อัพเดตสถานะปุ่มหมวดหมู่
            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.getAttribute('data-category') === categoryId) {
                    btn.classList.add('active');
                }
            });
            
            // อัพเดตข้อมูลหมวดหมู่
            updateCategoryInfo();
            
            // แสดงวิชาในหมวดหมู่
            renderCourses();
        }

        // อัพเดตข้อมูลหมวดหมู่
        function updateCategoryInfo() {
            if (!categoryInfo || !currentCategoryName || !courseCountElement) return;
            
            const category = categories.find(c => c.id === currentCategory);
            if (!category) return;
            
            currentCategoryName.textContent = `หมวดหมู่: ${category.name}`;
            
            // นับจำนวนวิชาในหมวดหมู่
            let courseCount = 0;
            if (currentCategory === 'all') {
                courseCount = Object.keys(courses).length;
            } else {
                courseCount = Object.keys(courses).filter(courseId => {
                    return courseId.startsWith(currentCategory);
                }).length;
            }
            
            courseCountElement.textContent = `${courseCount} วิชา`;
            
            // แสดงข้อมูลหมวดหมู่
            categoryInfo.style.display = 'flex';
        }

        // Load Courses (เบื้องต้น - โหลดข้อมูลวิชาเท่านั้น)
        async function loadCoursesInitial() {
            if (!isConnected) return;
            
            try {
                const snapshot = await db.collection('courses').get();
                courses = {};
                snapshot.forEach(doc => {
                    courses[doc.id] = { id: doc.id, ...doc.data() };
                });
                renderCourses();
                updateCategoryInfo();
            } catch (error) {
                console.error('Error loading courses:', error);
                showError('Load Courses Error', error.message);
            }
        }

        // Load Bookings สำหรับวิชาที่เลือก (โหลดเฉพาะเมื่อเลือกวิชา)
        async function loadBookingsForCourse() {
            if (!isConnected || !selectedCourse) return;
            
            try {
                const snapshot = await db.collection('bookings')
                    .where('courseId', '==', selectedCourse)
                    .get();
                
                bookings = {};
                snapshot.forEach(doc => {
                    bookings[doc.id] = { id: doc.id, ...doc.data() };
                });
                
                // Setup real-time listeners สำหรับวิชานี้
                setupRealtimeListenersForCourse();
                
            } catch (error) {
                console.error('Error loading bookings:', error);
                showError('Load Bookings Error', error.message);
            }
        }

        // Setup Real-time Listeners สำหรับวิชาที่เลือก
        function setupRealtimeListenersForCourse() {
            // Stop any existing listeners
            if (seatReservationsListener) {
                seatReservationsListener();
            }
            
            // Listen for seat reservations - REAL-TIME UPDATES
            seatReservationsListener = db.collection('seat_reservations')
                .where('courseId', '==', selectedCourse)
                .onSnapshot(snapshot => {
                    if (!isConnected) return;
                    
                    seatReservations = {};
                    let activeReservations = 0;
                    const currentUserId = getUserId();
                    const now = new Date();
                    
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        const reservationTime = new Date(data.reservedAt);
                        const timeDiff = (now - reservationTime) / 1000;
                        
                        if (timeDiff < RESERVATION_TIMEOUT_SECONDS) {
                            seatReservations[doc.id] = { id: doc.id, ...data };
                            if (data.userId !== currentUserId) {
                                activeReservations++;
                            }
                        }
                    });
                    
                    // Update active users count
                    updateActiveUsers(snapshot.size);
                    
                    // Show/hide reservation info
                    if (activeReservations > 0) {
                        showReservationInfo(activeReservations);
                    } else {
                        hideReservationInfo();
                    }
                    
                    renderSeats();
                    updateLastUpdateTime();
                    
                }, error => {
                    console.error('Seat reservations listener error:', error);
                    showError('Reservations listener error', error.message);
                });
        }

        // Update Active Users
        function updateActiveUsers(count) {
            activeUsers = count;
            if (activeUsersElement) {
                activeUsersElement.textContent = count;
            }
        }

        // Show Reservation Info
        function showReservationInfo(count) {
            if (seatReservationInfo && reservationDetails) {
                seatReservationInfo.classList.add('active');
                reservationDetails.textContent = `มีผู้ใช้งาน ${count} คนกำลังเลือกที่นั่งอยู่ในขณะนี้`;
            }
        }

        // Hide Reservation Info
        function hideReservationInfo() {
            if (seatReservationInfo) {
                seatReservationInfo.classList.remove('active');
            }
        }

        // Show Error Box
        function showError(title, message) {
            if (errorBox && errorDetails) {
                errorBox.classList.add('active');
                errorDetails.innerHTML = `<strong>${title}:</strong> ${message.replace(/\n/g, '<br>')}`;
            }
        }

        // Hide Error Box
        function hideError() {
            if (errorBox) {
                errorBox.classList.remove('active');
            }
        }

        // Cleanup expired reservations
        async function cleanupExpiredReservations() {
            if (!isConnected) return;
            
            try {
                const now = new Date();
                const snapshot = await db.collection('seat_reservations').get();
                
                const batch = db.batch();
                let deletedCount = 0;
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const reservationTime = new Date(data.reservedAt);
                    const timeDiff = (now - reservationTime) / 1000;
                    
                    if (timeDiff >= RESERVATION_TIMEOUT_SECONDS) {
                        batch.delete(doc.ref);
                        deletedCount++;
                    }
                });
                
                if (deletedCount > 0) {
                    await batch.commit();
                    if (debugMode) console.log(`Cleaned up ${deletedCount} expired reservations`);
                }
            } catch (error) {
                console.error('Error cleaning up expired reservations:', error);
            }
        }

        // Update Connection Status
        function updateConnectionStatus(text, status) {
            if (connectionStatus) {
                connectionStatus.innerHTML = `
                    <i class="fas fa-circle"></i>
                    <span>${text}</span>
                `;
                connectionStatus.className = `connection-status ${status}`;
            }
        }

        // Update Last Update Time
        function updateLastUpdateTime() {
            lastUpdateTime = new Date();
            if (lastUpdateElement) {
                lastUpdateElement.textContent = lastUpdateTime.toLocaleTimeString('th-TH');
            }
        }

        // Open Tab
        function openTab(tabId) {
            tabButtons.forEach(button => {
                button.classList.toggle('active', button.getAttribute('data-tab') === tabId);
            });
            
            tabContents.forEach(content => {
                content.classList.toggle('active', content.id === tabId);
            });
            
            // ซ่อนข้อความ error เมื่อเปลี่ยน tab
            hideError();
        }

        // Render Courses - แก้ไขให้แสดงเฉพาะหมวดหมู่ที่เลือก
        function renderCourses() {
            if (!coursesList) return;
            
            coursesList.innerHTML = '';
            
            if (Object.keys(courses).length === 0) {
                coursesList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-book"></i>
                        <h3>ยังไม่มีวิชาในระบบ</h3>
                        <p>กรุณาเพิ่มวิชาในหน้า "ผู้ดูแลระบบ"</p>
                    </div>
                `;
                return;
            }
            
            // กรองวิชาตามหมวดหมู่
            let filteredCourses = [];
            if (currentCategory === 'all') {
                filteredCourses = Object.keys(courses);
            } else {
                filteredCourses = Object.keys(courses).filter(courseId => {
                    return courseId.startsWith(currentCategory);
                });
            }
            
            if (filteredCourses.length === 0) {
                const category = categories.find(c => c.id === currentCategory);
                coursesList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-book"></i>
                        <h3>ไม่พบวิชาในหมวดหมู่ "${category ? category.name : currentCategory}"</h3>
                        <p>กรุณาเลือกหมวดหมู่อื่นหรือเพิ่มวิชาในหมวดหมู่นี้ในหน้า "ผู้ดูแลระบบ"</p>
                    </div>
                `;
                return;
            }
            
            // เรียงลำดับวิชา
            filteredCourses.sort();
            
            // แสดงวิชาทีละวิชา
            for (const courseId of filteredCourses) {
                const course = courses[courseId];
                
                // จำนวนที่นั่งจอง (คำนวณเบื้องต้น)
                let bookedCount = 0;
                // เนื่องจากยังไม่ได้โหลด bookings เราจะใช้ค่า 0 ไว้ก่อน
                
                const availableSeats = course.totalSeats - bookedCount;
                const percentage = Math.round((bookedCount / course.totalSeats) * 100);
                
                let progressColor = '#34a853';
                if (percentage >= 80) {
                    progressColor = '#000000';
                } else if (percentage >= 50) {
                    progressColor = '#fbbc04';
                }
                
                const courseCard = document.createElement('div');
                courseCard.className = 'course-card';
                courseCard.innerHTML = `
                    <h3>${course.name}</h3>
                    <p><i class="fas fa-code"></i> <strong>รหัสวิชา:</strong> ${courseId}</p>
                    <p><i class="fas fa-chalkboard-teacher"></i> <strong>อาจารย์:</strong> ${course.instructor || '-'}</p>
                    <p><i class="fas fa-clock"></i> <strong>เวลาเรียน:</strong> ${course.time || '-'}</p>
                    <p><i class="fas fa-info-circle"></i> <strong>คำอธิบาย:</strong> ${course.description || '-'}</p>
                    
                    <div class="seat-progress">
                        <div class="progress-bar" style="width: ${percentage}%; background: ${progressColor};"></div>
                    </div>
                    
                    <div class="seat-info">
                        <span class="available">
                            <i class="fas fa-chair"></i> ว่าง ${availableSeats} ที่นั่ง
                        </span>
                        <span class="booked">
                            <i class="fas fa-user-check"></i> จองแล้ว ${bookedCount} ที่นั่ง
                        </span>
                    </div>
                    
                    <button class="btn select-course" data-course-id="${courseId}">
                        <i class="fas fa-calendar-check"></i> เลือกวิชานี้
                    </button>
                `;
                
                coursesList.appendChild(courseCard);
            }
            
            // เพิ่ม event listener ให้กับปุ่มเลือกวิชา
            document.querySelectorAll('.select-course').forEach(button => {
                button.addEventListener('click', function() {
                    selectCourse(this.getAttribute('data-course-id'));
                });
            });
        }

        // Select Course
        async function selectCourse(courseId) {
            if (!isConnected) {
                showError('การเชื่อมต่อ', 'ไม่สามารถเชื่อมต่อกับฐานข้อมูลได้');
                return;
            }
            
            selectedCourse = courseId;
            const course = courses[courseId];
            
            if (!course) {
                showError('ไม่พบข้อมูล', 'ไม่พบข้อมูลวิชา');
                return;
            }
            
            // โหลดข้อมูลการจองสำหรับวิชานี้
            loadingText.textContent = 'กำลังโหลดข้อมูลการจอง...';
            loadingModal.classList.add('active');
            
            try {
                await loadBookingsForCourse();
                
                courseNameElement.textContent = course.name;
                courseDescriptionElement.textContent = course.description || '';
                courseCodeElement.textContent = courseId;
                courseInstructorElement.textContent = course.instructor || '-';
                courseTimeElement.textContent = course.time || '-';
                totalSeatsCountElement.textContent = course.totalSeats;
                
                bookingTab.disabled = false;
                openTab('booking');
                
                selectedSeats = [];
                selectedSeatsDisplay.textContent = 'ยังไม่มีการเลือกที่นั่ง';
                selectedSeatsDisplay.style.background = '#e8f4ea';
                selectedSeatsDisplay.style.color = '#34a853';
                studentNameInput.value = '';
                studentClassInput.value = '';
                
                clearReservation();
                confirmationBox.classList.remove('active');
                hideError();
                
                renderSeats();
                
            } catch (error) {
                console.error('Error loading course data:', error);
                showError('Error', 'ไม่สามารถโหลดข้อมูลวิชาได้');
            } finally {
                loadingModal.classList.remove('active');
            }
        }

        // Render Seats - WITH REAL-TIME RESERVATION UPDATES
        function renderSeats() {
            if (!selectedCourse || !isConnected || !seatsContainer) return;
            
            const course = courses[selectedCourse];
            if (!course) return;
            
            seatsContainer.innerHTML = '';
            
            let bookedCount = 0;
            const bookedSeats = {};
            
            // ตรวจสอบการจองจากข้อมูล bookings
            for (const bookingId in bookings) {
                const booking = bookings[bookingId];
                if (booking.courseId === selectedCourse) {
                    bookedSeats[booking.seatNumber] = {
                        booked: true,
                        studentName: booking.studentName,
                        studentClass: booking.studentClass
                    };
                    bookedCount++;
                }
            }
            
            const reservedSeats = {};
            const currentUserId = getUserId();
            const now = new Date();
            
            // ตรวจสอบการจองชั่วคราวจาก seatReservations
            for (const reservationId in seatReservations) {
                const reservation = seatReservations[reservationId];
                if (reservation.courseId === selectedCourse) {
                    const reservationTime = new Date(reservation.reservedAt);
                    const timeDiff = (now - reservationTime) / 1000;
                    
                    if (timeDiff < RESERVATION_TIMEOUT_SECONDS) {
                        reservedSeats[reservation.seatNumber] = {
                            reserved: true,
                            userId: reservation.userId,
                            reservedAt: reservation.reservedAt,
                            timeLeft: Math.floor(RESERVATION_TIMEOUT_SECONDS - timeDiff)
                        };
                    }
                }
            }
            
            const availableSeats = course.totalSeats - bookedCount;
            if (availableSeatsCountElement) {
                availableSeatsCountElement.textContent = availableSeats;
            }
            
            // สร้างที่นั่ง
            for (let i = 1; i <= course.totalSeats; i++) {
                const seat = document.createElement('div');
                seat.className = 'seat';
                seat.textContent = i;
                
                if (bookedSeats[i]) {
                    seat.classList.add('seat-booked');
                    seat.title = `จองแล้วโดย: ${bookedSeats[i].studentName} (${bookedSeats[i].studentClass})`;
                } else if (reservedSeats[i]) {
                    const reservation = reservedSeats[i];
                    if (reservation.userId === currentUserId) {
                        seat.classList.add('seat-selected');
                        seat.title = 'กำลังเลือก (สีเขียว) - คลิกซ้ำเพื่อยกเลิกการเลือก';
                        seat.addEventListener('click', () => selectSeat(i));
                    } else {
                        seat.classList.add('seat-reserving');
                        seat.title = `กำลังถูกเลือกโดยผู้อื่น (เหลือเวลา ${reservation.timeLeft} วินาที)`;
                    }
                } else {
                    seat.classList.add('seat-available');
                    seat.title = 'ที่นั่งว่าง - คลิกเพื่อเลือก';
                    seat.addEventListener('click', () => selectSeat(i));
                }
                
                seatsContainer.appendChild(seat);
            }
        }

        // Get unique user ID
        function getUserId() {
            let userId = localStorage.getItem('user_id');
            if (!userId) {
                userId = 'user_' + Math.random().toString(36).substr(2, 9) + '_' + Date.now();
                localStorage.setItem('user_id', userId);
            }
            return userId;
        }

        // Select Seat - MODIFIED VERSION: Click to select, click again to deselect
        async function selectSeat(seatNumber) {
            if (!isConnected) {
                showError('การเชื่อมต่อ', 'ไม่สามารถเชื่อมต่อกับฐานข้อมูลได้');
                return;
            }
            
            const currentUserId = getUserId();
            const now = new Date();
            
            // Check if seat is already selected by current user
            const isAlreadySelected = selectedSeats.includes(seatNumber);
            
            // If already selected, deselect it
            if (isAlreadySelected) {
                // Remove from selected seats
                selectedSeats = selectedSeats.filter(num => num !== seatNumber);
                
                // Delete seat reservation
                await deleteSeatReservation(seatNumber);
                
                // Update display
                updateSelectedSeatsDisplay();
                
                // Clear reservation if no seats selected
                if (selectedSeats.length === 0) {
                    clearReservation();
                } else {
                    // Update timer if seats still selected
                    startReservationTimer();
                }
                
                renderSeats();
                return;
            }
            
            // Check if seat is being reserved by someone else
            for (const reservationId in seatReservations) {
                const reservation = seatReservations[reservationId];
                if (reservation.courseId === selectedCourse && 
                    reservation.seatNumber === seatNumber &&
                    reservation.userId !== currentUserId) {
                    
                    const reservationTime = new Date(reservation.reservedAt);
                    const timeDiff = (now - reservationTime) / 1000;
                    const timeLeft = RESERVATION_TIMEOUT_SECONDS - timeDiff;
                    
                    if (timeLeft > 0) {
                        showMessage('ไม่สามารถเลือกที่นั่งนี้ได้', 
                            `ที่นั่ง ${seatNumber} กำลังถูกเลือกโดยผู้อื่น\n` +
                            `กรุณารอ ${Math.ceil(timeLeft)} วินาที หรือเลือกที่นั่งอื่น`
                        );
                        return;
                    }
                }
            }
            
            // Check if seat is already booked
            for (const bookingId in bookings) {
                const booking = bookings[bookingId];
                if (booking.courseId === selectedCourse && 
                    booking.seatNumber === seatNumber) {
                    showMessage('ไม่สามารถเลือกที่นั่งนี้ได้', 
                        `ที่นั่ง ${seatNumber} ถูกจองไปแล้ว`
                    );
                    return;
                }
            }
            
            // Add to selected seats
            selectedSeats.push(seatNumber);
            
            // Create seat reservation
            await createSeatReservation(seatNumber);
            
            // Update display and start timer
            updateSelectedSeatsDisplay();
            startReservationTimer();
            
            renderSeats();
        }

        // สร้างการจองชั่วคราว
        async function createSeatReservation(seatNumber) {
            try {
                const reservationId = `${selectedCourse}_${seatNumber}_${getUserId()}`;
                const reservationRef = db.collection('seat_reservations').doc(reservationId);
                
                await reservationRef.set({
                    courseId: selectedCourse,
                    seatNumber: seatNumber,
                    userId: getUserId(),
                    reservedAt: new Date().toISOString(),
                    expiresAt: new Date(Date.now() + RESERVATION_TIMEOUT_SECONDS * 1000).toISOString()
                });
                
                if (debugMode) console.log(`Reserved seat ${seatNumber} for course ${selectedCourse}`);
                
            } catch (error) {
                console.error('Error creating seat reservation:', error);
                showError('Reservation Error', error.message);
            }
        }

        // ลบการจองชั่วคราว
        async function deleteSeatReservation(seatNumber) {
            try {
                const reservationId = `${selectedCourse}_${seatNumber}_${getUserId()}`;
                await db.collection('seat_reservations').doc(reservationId).delete();
                
                if (debugMode) console.log(`Released seat ${seatNumber} for course ${selectedCourse}`);
            } catch (error) {
                console.error('Error deleting seat reservation:', error);
                showError('Delete Reservation Error', error.message);
            }
        }

        // อัพเดทการแสดงผล
        function updateSelectedSeatsDisplay() {
            if (!selectedSeatsDisplay) return;
            
            if (selectedSeats.length > 0) {
                selectedSeatsDisplay.textContent = selectedSeats.join(', ');
                selectedSeatsDisplay.style.background = '#e8f4ea';
                selectedSeatsDisplay.style.color = '#34a853';
                selectedSeatsDisplay.style.fontWeight = 'bold';
                selectedSeatsDisplay.style.borderColor = '#34a853';
                
                if (reservationTimeoutElement) {
                    reservationTimeoutElement.style.display = 'flex';
                }
                confirmationBox.classList.add('active');
            } else {
                selectedSeatsDisplay.textContent = 'ยังไม่มีการเลือกที่นั่ง';
                selectedSeatsDisplay.style.background = '#e8f4ea';
                selectedSeatsDisplay.style.color = '#34a853';
                selectedSeatsDisplay.style.fontWeight = 'normal';
                selectedSeatsDisplay.style.borderColor = '#34a853';
                
                if (reservationTimeoutElement) {
                    reservationTimeoutElement.style.display = 'none';
                }
                confirmationBox.classList.remove('active');
            }
        }

        // เริ่มนับเวลาถอยหลัง
        function startReservationTimer() {
            clearTimeout(reservationTimeout);
            clearInterval(reservationTimer);
            
            let timeLeft = RESERVATION_TIMEOUT_SECONDS;
            if (timeoutCountdownElement) {
                timeoutCountdownElement.textContent = timeLeft;
            }
            
            reservationTimer = setInterval(() => {
                timeLeft--;
                if (timeoutCountdownElement) {
                    timeoutCountdownElement.textContent = timeLeft;
                }
                
                if (timeLeft <= 0) {
                    clearReservation();
                    showMessage('หมดเวลาการจอง', 'เวลาจองที่นั่งหมดอายุแล้ว กรุณาเลือกที่นั่งใหม่');
                }
            }, 1000);
            
            reservationTimeout = setTimeout(() => {
                clearReservation();
            }, RESERVATION_TIMEOUT_SECONDS * 1000);
        }

        // ล้างการจองทั้งหมด
        async function clearReservation() {
            if (selectedCourse) {
                for (const seatNumber of selectedSeats) {
                    await deleteSeatReservation(seatNumber);
                }
            }
            
            selectedSeats = [];
            updateSelectedSeatsDisplay();
            
            clearTimeout(reservationTimeout);
            clearInterval(reservationTimer);
            
            if (reservationTimeoutElement) {
                reservationTimeoutElement.style.display = 'none';
            }
            confirmationBox.classList.remove('active');
            
            if (selectedCourse) {
                renderSeats();
            }
        }

        // Confirm Booking - FIXED VERSION
        async function confirmBooking() {
            if (isProcessingBooking) {
                showMessage('กำลังดำเนินการ', 'กรุณารอสักครู่ กำลังดำเนินการจอง...');
                return;
            }
            
            if (!isConnected) {
                showError('การเชื่อมต่อ', 'ไม่สามารถเชื่อมต่อกับฐานข้อมูลได้');
                return;
            }
            
            if (!selectedCourse) {
                showError('การเลือกวิชา', 'กรุณาเลือกวิชาก่อน');
                return;
            }
            
            if (selectedSeats.length === 0) {
                showError('การเลือกที่นั่ง', 'กรุณาเลือกที่นั่งก่อน');
                return;
            }
            
            const studentName = studentNameInput.value.trim();
            const studentClass = studentClassInput.value.trim();
            
            if (!studentName) {
                showError('ข้อมูลไม่ครบ', 'กรุณากรอกชื่อ-นามสกุล');
                studentNameInput.focus();
                return;
            }
            
            if (!studentClass) {
                showError('ข้อมูลไม่ครบ', 'กรุณากรอกห้องเรียน');
                studentClassInput.focus();
                return;
            }
            
            try {
                isProcessingBooking = true;
                confirmBookingBtn.disabled = true;
                confirmBookingBtn.classList.add('btn-disabled');
                
                loadingText.textContent = 'กำลังตรวจสอบที่นั่ง...';
                loadingModal.classList.add('active');
                
                const bookingTime = new Date().toISOString();
                const bookingDate = new Date().toISOString().split('T')[0];
                const bookingIds = [];
                const failedSeats = [];
                
                // Process each seat individually
                for (const seatNumber of selectedSeats) {
                    try {
                        loadingText.textContent = `กำลังตรวจสอบที่นั่ง ${seatNumber}...`;
                        
                        // ตรวจสอบว่ามีการจองอยู่แล้วหรือไม่
                        const existingBooking = await db.collection('bookings')
                            .where('courseId', '==', selectedCourse)
                            .where('seatNumber', '==', seatNumber)
                            .get();
                        
                        if (!existingBooking.empty) {
                            throw new Error(`ที่นั่ง ${seatNumber} ถูกจองไปแล้ว`);
                        }
                        
                        // ลบการจองชั่วคราว
                        const reservationId = `${selectedCourse}_${seatNumber}_${getUserId()}`;
                        await db.collection('seat_reservations').doc(reservationId).delete();
                        
                        // สร้างการจองใหม่
                        const bookingRef = await db.collection('bookings').add({
                            courseId: selectedCourse,
                            seatNumber: seatNumber,
                            studentName: studentName,
                            studentClass: studentClass,
                            bookingTime: bookingTime,
                            bookingDate: bookingDate,
                            createdAt: new Date().toISOString()
                        });
                        
                        bookingIds.push({ seatNumber, bookingId: bookingRef.id });
                        
                    } catch (error) {
                        console.error(`Error reserving seat ${seatNumber}:`, error);
                        failedSeats.push({
                            seatNumber: seatNumber,
                            error: error.message
                        });
                    }
                }
                
                loadingModal.classList.remove('active');
                
                if (failedSeats.length === 0) {
                    const seatsList = selectedSeats.join(', ');
                    showMessage('สำเร็จ', 
                        `จองที่นั่ง ${seatsList} สำเร็จ!\n\n` +
                        `ชื่อ: ${studentName}\n` +
                        `ห้องเรียน: ${studentClass}\n` +
                        `วิชา: ${selectedCourse}\n` +
                        `หมายเลขการจอง: ${bookingIds[0].bookingId.substring(0, 8)}\n\n` +
                        `โปรดบันทึกข้อมูลนี้ไว้`
                    );
                    
                    clearReservation();
                    studentNameInput.value = '';
                    studentClassInput.value = '';
                    
                    // อัพเดตข้อมูล bookings ใหม่
                    await loadBookingsForCourse();
                    
                } else if (bookingIds.length > 0) {
                    const successSeats = bookingIds.map(b => b.seatNumber).join(', ');
                    const failedSeatsList = failedSeats.map(f => f.seatNumber).join(', ');
                    
                    showMessage('มีบางที่นั่งไม่สำเร็จ', 
                        `จองสำเร็จ: ที่นั่ง ${successSeats}\n` +
                        `ไม่สำเร็จ: ที่นั่ง ${failedSeatsList}\n\n` +
                        `ชื่อ: ${studentName}\n` +
                        `ห้องเรียน: ${studentClass}\n` +
                        `วิชา: ${selectedCourse}\n\n` +
                        `กรุณาลองเลือกที่นั่งอื่นหรือติดต่อผู้ดูแล`
                    );
                    
                    selectedSeats = failedSeats.map(f => f.seatNumber);
                    updateSelectedSeatsDisplay();
                    
                    renderSeats();
                    
                } else {
                    const errorMessages = failedSeats.map(f => `ที่นั่ง ${f.seatNumber}: ${f.error}`).join('\n');
                    showMessage('การจองไม่สำเร็จ', 
                        `ไม่สามารถจองที่นั่งได้:\n\n` +
                        errorMessages + '\n\n' +
                        `กรุณาเลือกที่นั่งใหม่และลองอีกครั้ง`
                    );
                    
                    renderSeats();
                }
                
            } catch (error) {
                console.error('Error in confirmBooking:', error);
                loadingModal.classList.remove('active');
                
                let errorMessage = 'เกิดข้อผิดพลาดในการจอง\n\n';
                if (error.code === 'permission-denied') {
                    errorMessage += 'สิทธิ์ไม่เพียงพอ: กรุณาตรวจสอบ Firebase Rules\n';
                } else if (error.code === 'unavailable') {
                    errorMessage += 'ไม่สามารถเชื่อมต่อกับฐานข้อมูลได้\n';
                } else {
                    errorMessage += 'ข้อผิดพลาด: ' + error.message + '\n';
                }
                
                errorMessage += '\nกรุณาลองใหม่อีกครั้งหรือติดต่อผู้ดูแล';
                showError('การจองล้มเหลว', errorMessage);
                
            } finally {
                isProcessingBooking = false;
                confirmBookingBtn.disabled = false;
                confirmBookingBtn.classList.remove('btn-disabled');
            }
        }

        // Show Debug Info
        function showDebugInfo() {
            const debugInfo = `
                Firebase Status:
                - Connected: ${isConnected}
                - Project ID: ${firebaseConfig.projectId}
                
                Application Status:
                - Selected Course: ${selectedCourse || 'None'}
                - Selected Seats: ${selectedSeats.join(', ') || 'None'}
                - User ID: ${getUserId()}
                - Active Users: ${activeUsers}
                - Current Category: ${currentCategory}
                
                Data Counts:
                - Courses: ${Object.keys(courses).length}
                - Bookings: ${Object.keys(bookings).length}
                - Reservations: ${Object.keys(seatReservations).length}
                
                Last Update: ${lastUpdateTime ? lastUpdateTime.toLocaleTimeString() : 'Never'}
            `;
            
            console.log('Debug Info:', debugInfo);
            showMessage('Debug Information', debugInfo.replace(/\n/g, '<br>'));
        }

        // Show Message
        function showMessage(title, text) {
            if (messageTitle && messageText) {
                messageTitle.textContent = title;
                messageText.innerHTML = text.replace(/\n/g, '<br>');
                messageModal.classList.add('active');
            }
        }

        // Close Message
        function closeMessage() {
            if (messageModal) {
                messageModal.classList.remove('active');
            }
        }
    </script>
</body>
</html>
