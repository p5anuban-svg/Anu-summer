<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบจองที่นั่งเรียน</title>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #1a73e8;
            --primary-dark: #0d47a1;
            --success: #34a853;
            --success-light: #81c995;
            --warning: #fbbc04;
            --booked: #000000;         /* เปลี่ยนสีแดงเป็นสีดำสำหรับสถานะจองแล้ว */
            --reserving: #ff6b35;
            --gray: #5f6368;
            --light-gray: #f5f7fa;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--light-gray);
            color: #333;
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            position: relative;
        }

        header {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            padding: 20px 30px;
            text-align: center;
            position: relative;
        }

        header h1 {
            margin-bottom: 10px;
            font-size: 2.2rem;
        }

        .admin-link {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.2);
            padding: 8px 15px;
            border-radius: 5px;
            color: white;
            text-decoration: none;
            font-size: 0.9rem;
            transition: all 0.3s;
            border: 1px solid rgba(255, 255, 255, 0.3);
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .admin-link:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
            text-decoration: none;
            color: white;
        }

        /* ตรงนี้จะลบส่วนของ Modal Admin Login ออก */
        /* และแก้ไขปุ่มให้ลิงก์ไป admin.html โดยตรง */

        /* ส่วนอื่นๆ คงเดิมทั้งหมด */
        
        .nav-tabs {
            display: flex;
            background-color: #f1f3f4;
            border-bottom: 1px solid #ddd;
        }

        .tab-button {
            flex: 1;
            padding: 15px;
            background: none;
            border: none;
            font-size: 1rem;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .tab-button:hover {
            background-color: #e8f0fe;
        }

        .tab-button.active {
            background-color: white;
            border-bottom: 3px solid var(--primary);
            font-weight: bold;
            color: var(--primary);
        }

        .tab-content {
            padding: 30px;
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .courses-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .course-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            transition: transform 0.3s, box-shadow 0.3s;
            background-color: white;
            position: relative;
            overflow: hidden;
        }

        .course-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 5px;
            height: 100%;
            background: var(--primary);
        }

        .course-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }

        .course-card h3 {
            color: var(--primary);
            margin-bottom: 10px;
            font-size: 1.3rem;
        }

        .course-card p {
            margin-bottom: 8px;
            color: #666;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .course-card p i {
            width: 20px;
            color: var(--gray);
        }

        .seat-progress {
            margin: 15px 0;
            height: 8px;
            background: #f0f0f0;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            transition: width 0.5s;
        }

        .seat-info {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
            font-weight: bold;
            font-size: 0.95rem;
        }

        .available {
            color: var(--primary);
        }

        .booked {
            color: var(--booked); /* เปลี่ยนเป็นสีดำ */
        }

        .reserving {
            color: var(--reserving);
        }

        .btn {
            display: inline-block;
            padding: 10px 20px;
            background-color: var(--primary);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            text-decoration: none;
            transition: all 0.3s;
            margin-top: 10px;
            width: 100%;
            text-align: center;
        }

        .btn:hover {
            background-color: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .btn-secondary {
            background-color: var(--gray);
        }

        .btn-secondary:hover {
            background-color: #4a4d52;
        }

        .btn-success {
            background-color: var(--success);
        }

        .btn-success:hover {
            background-color: #2e8b47;
        }

        .btn-danger {
            background-color: var(--booked); /* เปลี่ยนปุ่มลบเป็นสีดำ */
            color: white;
        }

        .btn-danger:hover {
            background-color: #333333;
        }

        .booking-container {
            display: flex;
            flex-wrap: wrap;
            gap: 30px;
        }

        .seats-section {
            flex: 2;
            min-width: 300px;
        }

        .info-section {
            flex: 1;
            min-width: 250px;
        }

        .screen {
            background: linear-gradient(to right, #333, #555);
            color: white;
            text-align: center;
            padding: 15px;
            margin-bottom: 30px;
            border-radius: 5px;
            font-weight: bold;
            letter-spacing: 3px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .seats-grid {
            display: grid;
            grid-template-columns: repeat(10, 1fr);
            gap: 8px;
            margin-bottom: 30px;
        }

        .seat {
            width: 40px;
            height: 40px;
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.2s;
            user-select: none;
            position: relative;
        }

        .seat::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            opacity: 0;
            transition: opacity 0.2s;
        }

        .seat:hover::after {
            opacity: 1;
        }

        .seat:hover {
            transform: scale(1.1);
        }

        .seat-available {
            background-color: var(--primary);
            color: white;
        }

        .seat-selected {
            background-color: var(--success);
            color: white;
            animation: greenPulse 2s infinite;
            box-shadow: 0 0 10px rgba(52, 168, 83, 0.5);
        }

        @keyframes greenPulse {
            0% { 
                background-color: var(--success);
                box-shadow: 0 0 5px rgba(52, 168, 83, 0.5);
            }
            50% { 
                background-color: var(--success-light);
                box-shadow: 0 0 15px rgba(52, 168, 83, 0.8);
            }
            100% { 
                background-color: var(--success);
                box-shadow: 0 0 5px rgba(52, 168, 83, 0.5);
            }
        }

        .seat-reserving {
            background-color: var(--reserving);
            color: white;
            animation: reservingPulse 2s infinite;
        }

        @keyframes reservingPulse {
            0% { 
                background-color: var(--reserving);
                opacity: 0.8;
            }
            50% { 
                background-color: #ff8c66;
                opacity: 1;
            }
            100% { 
                background-color: var(--reserving);
                opacity: 0.8;
            }
        }

        .seat-booked {
            background-color: var(--booked); /* เปลี่ยนเป็นสีดำ */
            color: white;
            cursor: not-allowed;
            opacity: 0.9;
        }

        .seat-legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 5px 10px;
            background: #f8f9fa;
            border-radius: 5px;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 3px;
        }

        .booking-form {
            background-color: #f8f9fa;
            padding: 25px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .booking-form h3 {
            color: var(--primary);
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--primary);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #444;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        .form-group input:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 3px rgba(26, 115, 232, 0.1);
        }

        .input-hint {
            font-size: 0.85rem;
            color: #666;
            margin-top: 5px;
            font-style: italic;
        }

        .selected-seats {
            padding: 15px;
            background: #e8f4ea;
            border-radius: 5px;
            min-height: 50px;
            border: 2px dashed var(--success);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: var(--success);
            transition: all 0.3s;
        }

        .booking-info {
            background: linear-gradient(135deg, #f8f9fa, #e8f0fe);
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .booking-info h3 {
            color: var(--primary);
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--primary);
        }

        .booking-info p {
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .booking-info strong {
            color: #444;
            min-width: 120px;
        }

        .booking-info span {
            color: var(--primary);
            font-weight: bold;
        }

        footer {
            text-align: center;
            padding: 20px;
            color: #666;
            font-size: 0.9rem;
            border-top: 1px solid #eee;
            margin-top: 30px;
            background: #f8f9fa;
        }

        .footer-links {
            margin-top: 10px;
            display: flex;
            justify-content: center;
            gap: 20px;
        }

        .footer-links a {
            color: var(--primary);
            text-decoration: none;
            font-size: 0.85rem;
            transition: color 0.3s;
        }

        .footer-links a:hover {
            color: var(--primary-dark);
            text-decoration: underline;
        }

        .connection-status {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            margin-top: 10px;
        }

        .connection-status.connected {
            background: #e6f4ea;
            color: var(--success);
        }

        .connection-status.disconnected {
            background: #fdecea;
            color: var(--booked);
        }

        .connection-status.connecting {
            background: #fef7e0;
            color: var(--warning);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            animation: slideUp 0.3s;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal h2 {
            margin-bottom: 20px;
            color: var(--primary);
        }

        .close-modal {
            float: right;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
            transition: color 0.3s;
        }

        .close-modal:hover {
            color: var(--booked);
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .empty-state {
            grid-column: 1 / -1;
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .empty-state i {
            font-size: 4rem;
            margin-bottom: 20px;
            color: #ddd;
        }

        .btn-disabled {
            background-color: #cccccc !important;
            color: #666666 !important;
            cursor: not-allowed !important;
            transform: none !important;
            box-shadow: none !important;
        }

        .reservation-timeout {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            margin-top: 10px;
            background: #e8f4ea;
            color: var(--success);
        }

        .confirmation-box {
            background: #e8f4ea;
            border: 2px solid var(--success);
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            display: none;
        }

        .confirmation-box.active {
            display: block;
        }

        @media (max-width: 768px) {
            .seats-grid {
                grid-template-columns: repeat(5, 1fr);
            }
            
            .booking-container {
                flex-direction: column;
            }
            
            .admin-link {
                position: static;
                display: inline-block;
                margin-top: 10px;
            }
            
            .legend-item {
                padding: 3px 6px;
                font-size: 0.9rem;
            }
        }

        @media (max-width: 480px) {
            .seats-grid {
                grid-template-columns: repeat(4, 1fr);
                gap: 5px;
            }
            
            .seat {
                width: 35px;
                height: 35px;
                font-size: 0.9rem;
            }
            
            .courses-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-chair"></i> ระบบจองที่นั่งเรียน</h1>
            <p>มหาวิทยาลัยเทคโนโลยีแห่งการเรียนรู้</p>
            <!-- เปลี่ยนลิงก์ให้ไปที่ admin.html โดยตรง -->
            <a href="admin.html" class="admin-link" id="admin-access-link">
                <i class="fas fa-user-shield"></i> ผู้ดูแลระบบ
            </a>
        </header>

        <div class="nav-tabs">
            <button class="tab-button active" data-tab="home">หน้าหลัก</button>
            <button class="tab-button" data-tab="booking" id="booking-tab" disabled>จองที่นั่ง</button>
            <button class="tab-button" data-tab="help">วิธีใช้</button>
        </div>

        <!-- หน้าหลัก -->
        <div id="home" class="tab-content active">
            <h2><i class="fas fa-book-open"></i> เลือกรายวิชา</h2>
            <p>เลือกวิชาที่ต้องการจองที่นั่งเรียน ข้อมูลจะอัพเดตแบบเรียลไทม์</p>
            
            <div class="connection-status connecting" id="connection-status">
                <i class="fas fa-circle"></i>
                <span>กำลังเชื่อมต่อกับฐานข้อมูล...</span>
            </div>
            
            <div id="courses-list" class="courses-grid">
                <!-- วิชาจะแสดงที่นี่ -->
            </div>
        </div>

        <!-- จองที่นั่ง -->
        <div id="booking" class="tab-content">
            <h2>จองที่นั่งเรียน: <span id="course-name"></span></h2>
            <p id="course-description"></p>
            
            <div class="booking-container">
                <div class="seats-section">
                    <div class="screen">หน้าห้องเรียน</div>
                    <div class="seats-grid" id="seats-container">
                        <!-- ที่นั่งจะแสดงที่นี่ -->
                    </div>
                    
                    <div class="seat-legend">
                        <div class="legend-item">
                            <div class="legend-color seat-available"></div>
                            <span>ว่าง (คลิกเพื่อเลือก)</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color seat-selected"></div>
                            <span>กำลังเลือก (สีเขียว)</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color seat-reserving"></div>
                            <span>กำลังถูกเลือกโดยผู้อื่น</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color seat-booked"></div>
                            <span>จองแล้ว (สีดำ)</span>
                        </div>
                    </div>
                    
                    <div class="reservation-timeout" id="reservation-timeout" style="display: none;">
                        <i class="fas fa-clock"></i>
                        <span>การจองที่นั่งจะหมดอายุใน <span id="timeout-countdown">30</span> วินาที</span>
                    </div>
                </div>
                
                <div class="info-section">
                    <div class="booking-form">
                        <h3><i class="fas fa-user"></i> ข้อมูลการจอง</h3>
                        <div class="form-group">
                            <label for="student-name"><i class="fas fa-user-circle"></i> ชื่อ-นามสกุล *</label>
                            <input type="text" id="student-name" placeholder="กรุณากรอกชื่อ-นามสกุล" required>
                        </div>
                        <div class="form-group">
                            <label for="student-class"><i class="fas fa-school"></i> ห้องเรียน *</label>
                            <input type="text" id="student-class" placeholder="ตัวอย่าง: ป.1/1, ม.3/2" required>
                            <div class="input-hint">กรอกห้องเรียนของคุณ เช่น ป.1/1, ม.3/2, อ.2, ห้อง 101</div>
                        </div>
                        <div class="form-group">
                            <label><i class="fas fa-chair"></i> ที่นั่งที่เลือก:</label>
                            <div class="selected-seats" id="selected-seats-display">
                                ยังไม่มีการเลือกที่นั่ง
                            </div>
                        </div>
                        
                        <div class="confirmation-box" id="confirmation-box">
                            <h4><i class="fas fa-check-circle" style="color: var(--success);"></i> ยืนยันการจอง</h4>
                            <p>กรุณายืนยันการจองภายใน 30 วินาที</p>
                            <p>การจองจะถูกยกเลิกอัตโนมัติหลังจากหมดเวลา</p>
                        </div>
                        
                        <button class="btn btn-success" id="confirm-booking">
                            <i class="fas fa-check-circle"></i> ยืนยันการจอง
                        </button>
                        <button class="btn btn-secondary" id="back-to-courses">
                            <i class="fas fa-arrow-left"></i> กลับหน้าแรก
                        </button>
                    </div>
                    
                    <div class="booking-info">
                        <h3><i class="fas fa-info-circle"></i> ข้อมูลวิชา</h3>
                        <p><strong><i class="fas fa-code"></i> รหัสวิชา:</strong> <span id="course-code"></span></p>
                        <p><strong><i class="fas fa-chalkboard-teacher"></i> อาจารย์:</strong> <span id="course-instructor"></span></p>
                        <p><strong><i class="fas fa-clock"></i> เวลาเรียน:</strong> <span id="course-time"></span></p>
                        <p><strong><i class="fas fa-chair"></i> จำนวนที่นั่ง:</strong> 
                            <span id="available-seats-count">0</span> / <span id="total-seats-count">0</span>
                        </p>
                        <p><strong><i class="fas fa-history"></i> อัพเดตล่าสุด:</strong> <span id="last-update">-</span></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- วิธีใช้ -->
        <div id="help" class="tab-content">
            <h2><i class="fas fa-question-circle"></i> วิธีใช้ระบบ</h2>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 20px;">
                <div style="background: #e8f0fe; padding: 20px; border-radius: 8px;">
                    <h3 style="color: var(--primary); margin-bottom: 15px;">
                        <i class="fas fa-user-graduate"></i> สำหรับนักเรียน
                    </h3>
                    <ol style="margin-left: 20px; line-height: 1.8;">
                        <li>เลือกวิชาจากหน้าหลัก</li>
                        <li>เลือกที่นั่งที่ว่าง (สีฟ้า)</li>
                        <li>กรอกชื่อ-นามสกุลและห้องเรียน</li>
                        <li>คลิกยืนยันการจองภายใน 30 วินาที</li>
                        <li>บันทึกข้อมูลการจองที่ได้รับ</li>
                    </ol>
                    <p style="margin-top: 10px; color: var(--success);">
                        <i class="fas fa-lightbulb"></i> ที่นั่งสีเขียว = กำลังเลือกอยู่
                    </p>
                    <p style="margin-top: 5px; color: var(--booked);">
                        <i class="fas fa-lightbulb"></i> ที่นั่งสีดำ = จองแล้ว
                    </p>
                </div>
                
                <div style="background: #f0f8f0; padding: 20px; border-radius: 8px;">
                    <h3 style="color: var(--success); margin-bottom: 15px;">
                        <i class="fas fa-chalkboard-teacher"></i> สำหรับอาจารย์
                    </h3>
                    <p>คลิกปุ่ม <a href="admin.html" style="color: var(--primary); text-decoration: underline;">ผู้ดูแลระบบ</a> ที่มุมขวาบน</p>
                    <p>กรุณาเข้าสู่ระบบเพื่อใช้งานส่วนผู้ดูแล</p>
                    <div class="admin-login-form" style="margin-top: 15px; padding: 15px; background: #e8f4ea; border-radius: 5px;">
                        <h4 style="color: var(--success); margin-bottom: 10px;">เข้าสู่ระบบผู้ดูแล</h4>
                        <p>ผู้ใช้: <strong>admin</strong></p>
                        <p>รหัสผ่าน: <strong>admin123</strong></p>
                        <a href="admin.html" class="btn btn-success" style="width: 100%; padding: 8px; margin-top: 10px;">
                            <i class="fas fa-sign-in-alt"></i> ไปที่หน้าผู้ดูแล
                        </a>
                    </div>
                    <p style="margin-top: 10px; color: var(--gray); font-size: 0.9rem;">
                        <i class="fas fa-key"></i> รหัสผ่านเริ่มต้น: admin123
                    </p>
                </div>
            </div>
            
            <div style="background: #fef7e0; padding: 20px; border-radius: 8px; margin-top: 20px;">
                <h3 style="color: var(--warning); margin-bottom: 15px;">
                    <i class="fas fa-lightbulb"></i> เคล็ดลับการใช้งาน
                </h3>
                <ul style="margin-left: 20px; line-height: 1.8;">
                    <li>ข้อมูลอัพเดตแบบเรียลไทม์ ไม่ต้องรีเฟรชหน้า</li>
                    <li>สามารถจองหลายที่นั่งพร้อมกันได้</li>
                    <li>ถ้าไม่เห็นวิชาแสดงขึ้นมา ให้รอสักครู่</li>
                    <li>มีปัญหาการใช้งานให้แจ้งผู้ดูแลระบบ</li>
                    <li>ที่นั่งสีส้มหมายถึงมีคนอื่นกำลังเลือกอยู่</li>
                    <li>ที่นั่งสีเขียวหมายถึงคุณกำลังเลือกอยู่</li>
                    <li>ที่นั่งสีดำหมายถึงจองแล้วโดยผู้อื่น</li>
                </ul>
            </div>
            
            <div style="text-align: center; margin-top: 30px;">
                <a href="admin.html" class="btn" style="padding: 15px 30px;">
                    <i class="fas fa-user-shield"></i> ไปที่หน้าผู้ดูแลระบบ
                </a>
            </div>
        </div>

        <footer>
            <p>ระบบจองที่นั่งเรียน &copy; 2023 - พัฒนาด้วย Firebase</p>
            <div class="footer-links">
                <a href="./"><i class="fas fa-home"></i> หน้าหลัก</a>
                <a href="#help"><i class="fas fa-question-circle"></i> วิธีใช้</a>
                <a href="admin.html" id="footer-admin-link"><i class="fas fa-user-shield"></i> ผู้ดูแล</a>
            </div>
        </footer>
    </div>

    <!-- Modal แสดงข้อความ -->
    <div id="message-modal" class="modal">
        <div class="modal-content">
            <span class="close-modal" id="close-message">&times;</span>
            <h2 id="message-title">ข้อความ</h2>
            <p id="message-text"></p>
            <button class="btn" id="btn-close-message" style="margin-top: 20px;">ตกลง</button>
        </div>
    </div>

    <!-- Loading Modal -->
    <div id="loading-modal" class="modal">
        <div class="modal-content" style="text-align: center;">
            <div class="loading" style="width: 40px; height: 40px; margin: 20px auto;"></div>
            <h3>กำลังดำเนินการ...</h3>
            <p id="loading-text">กำลังตรวจสอบที่นั่งและบันทึกข้อมูล</p>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAIawhBmDnJs2rfAoThFFG-8llvIk1--aU",
            authDomain: "exam-test-ac-me.firebaseapp.com",
            projectId: "exam-test-ac-me",
            storageBucket: "exam-test-ac-me.firebasestorage.app",
            messagingSenderId: "1064778433498",
            appId: "1:1064778433498:web:b57dd308fd48fdc57b76e3"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Global Variables
        let selectedCourse = null;
        let selectedSeats = [];
        let courses = {};
        let bookings = {};
        let seatReservations = {};
        let isConnected = false;
        let lastUpdateTime = null;
        let isProcessingBooking = false;
        let reservationTimeout = null;
        let reservationTimer = null;
        const RESERVATION_TIMEOUT_SECONDS = 30;

        // DOM Elements
        const tabButtons = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('.tab-content');
        const coursesList = document.getElementById('courses-list');
        const bookingTab = document.getElementById('booking-tab');
        const seatsContainer = document.getElementById('seats-container');
        const courseNameElement = document.getElementById('course-name');
        const courseDescriptionElement = document.getElementById('course-description');
        const courseCodeElement = document.getElementById('course-code');
        const courseInstructorElement = document.getElementById('course-instructor');
        const courseTimeElement = document.getElementById('course-time');
        const availableSeatsCountElement = document.getElementById('available-seats-count');
        const totalSeatsCountElement = document.getElementById('total-seats-count');
        const selectedSeatsDisplay = document.getElementById('selected-seats-display');
        const confirmBookingBtn = document.getElementById('confirm-booking');
        const backToCoursesBtn = document.getElementById('back-to-courses');
        const studentNameInput = document.getElementById('student-name');
        const studentClassInput = document.getElementById('student-class');
        const connectionStatus = document.getElementById('connection-status');
        const lastUpdateElement = document.getElementById('last-update');
        const messageModal = document.getElementById('message-modal');
        const loadingModal = document.getElementById('loading-modal');
        const reservationTimeoutElement = document.getElementById('reservation-timeout');
        const timeoutCountdownElement = document.getElementById('timeout-countdown');
        const confirmationBox = document.getElementById('confirmation-box');
        const adminAccessLink = document.getElementById('admin-access-link');
        const footerAdminLink = document.getElementById('footer-admin-link');
        const messageTitle = document.getElementById('message-title');
        const messageText = document.getElementById('message-text');
        const loadingText = document.getElementById('loading-text');
        const closeMessageBtn = document.getElementById('close-message');
        const btnCloseMessage = document.getElementById('btn-close-message');

        // Event Listeners
        document.addEventListener('DOMContentLoaded', initializeApp);
        
        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                const tabId = button.getAttribute('data-tab');
                openTab(tabId);
            });
        });

        backToCoursesBtn.addEventListener('click', () => {
            clearReservation();
            openTab('home');
        });
        
        confirmBookingBtn.addEventListener('click', confirmBooking);
        closeMessageBtn.addEventListener('click', closeMessage);
        btnCloseMessage.addEventListener('click', closeMessage);

        // Prevent default behavior for admin links
        document.querySelectorAll('a[href="#"]').forEach(link => {
            link.addEventListener('click', (e) => e.preventDefault());
        });

        // Initialize App
        async function initializeApp() {
            updateConnectionStatus('กำลังเชื่อมต่อกับฐานข้อมูล...', 'connecting');
            
            try {
                // Test Firebase connection
                const testRef = db.collection('test_connection');
                await testRef.add({
                    timestamp: new Date().toISOString(),
                    test: true
                });
                
                updateConnectionStatus('เชื่อมต่อกับฐานข้อมูลสำเร็จ', 'connected');
                isConnected = true;
                
                // Initialize sample data if empty
                await initializeSampleData();
                
                // Setup real-time listeners
                setupRealtimeListeners();
                
                // Initial load
                await loadCourses();
                await loadBookings();
                
            } catch (error) {
                console.error("Connection error:", error);
                updateConnectionStatus('เชื่อมต่อกับฐานข้อมูลล้มเหลว', 'disconnected');
                isConnected = false;
                
                // Show error message
                showMessage('ข้อผิดพลาด', 
                    'ไม่สามารถเชื่อมต่อกับฐานข้อมูลได้\n\n' +
                    'กรุณาตรวจสอบ:\n' +
                    '1. การเชื่อมต่ออินเทอร์เน็ต\n' +
                    '2. Firebase Security Rules\n' +
                    '3. โปรเจค Firebase Configuration'
                );
            }
        }

        // Initialize Sample Data
        async function initializeSampleData() {
            try {
                const coursesSnapshot = await db.collection('courses').get();
                
                if (coursesSnapshot.empty) {
                    console.log('Creating sample courses...');
                    
                    const sampleCourses = [
                        {
                            id: 'CS101',
                            data: {
                                name: 'การเขียนโปรแกรมคอมพิวเตอร์',
                                totalSeats: 30,
                                instructor: 'อาจารย์สมชาย ใจดี',
                                time: 'จันทร์ 09:00-12:00',
                                description: 'วิชาพื้นฐานการเขียนโปรแกรมด้วยภาษา Python',
                                createdAt: new Date().toISOString()
                            }
                        },
                        {
                            id: 'MATH201',
                            data: {
                                name: 'คณิตศาสตร์ดิสครีต',
                                totalSeats: 25,
                                instructor: 'อาจารย์สมหญิง เก่งกล้า',
                                time: 'อังคาร 13:00-16:00',
                                description: 'วิชาคณิตศาสตร์สำหรับนักคอมพิวเตอร์',
                                createdAt: new Date().toISOString()
                            }
                        },
                        {
                            id: 'ENG102',
                            data: {
                                name: 'ภาษาอังกฤษเพื่อการสื่อสาร',
                                totalSeats: 40,
                                instructor: 'อาจารย์ John Smith',
                                time: 'พุธ 10:00-13:00',
                                description: 'พัฒนาทักษะภาษาอังกฤษเพื่อการสื่อสาร',
                                createdAt: new Date().toISOString()
                            }
                        }
                    ];
                    
                    const batch = db.batch();
                    sampleCourses.forEach(course => {
                        const courseRef = db.collection('courses').doc(course.id);
                        batch.set(courseRef, course.data);
                    });
                    
                    await batch.commit();
                    console.log('Sample courses created successfully');
                }
            } catch (error) {
                console.error('Error initializing sample data:', error);
            }
        }

        // Setup Real-time Listeners
        function setupRealtimeListeners() {
            // Listen for course changes
            db.collection('courses').onSnapshot(snapshot => {
                if (!isConnected) return;
                
                courses = {};
                snapshot.forEach(doc => {
                    courses[doc.id] = doc.data();
                });
                renderCourses();
                updateLastUpdateTime();
            }, error => {
                console.error('Courses listener error:', error);
            });

            // Listen for booking changes
            db.collection('bookings').onSnapshot(snapshot => {
                if (!isConnected) return;
                
                bookings = {};
                snapshot.forEach(doc => {
                    bookings[doc.id] = { id: doc.id, ...doc.data() };
                });
                renderCourses();
                if (selectedCourse) {
                    renderSeats();
                }
                updateLastUpdateTime();
            }, error => {
                console.error('Bookings listener error:', error);
            });

            // Listen for seat reservations
            db.collection('seat_reservations').onSnapshot(snapshot => {
                if (!isConnected) return;
                
                seatReservations = {};
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const reservationTime = new Date(data.reservedAt);
                    const currentTime = new Date();
                    const timeDiff = (currentTime - reservationTime) / 1000;
                    
                    if (timeDiff < RESERVATION_TIMEOUT_SECONDS) {
                        seatReservations[doc.id] = { id: doc.id, ...data };
                    } else {
                        db.collection('seat_reservations').doc(doc.id).delete();
                    }
                });
                
                if (selectedCourse) {
                    renderSeats();
                }
            }, error => {
                console.error('Seat reservations listener error:', error);
            });
        }

        // Update Connection Status
        function updateConnectionStatus(text, status) {
            connectionStatus.innerHTML = `
                <i class="fas fa-circle"></i>
                <span>${text}</span>
            `;
            connectionStatus.className = `connection-status ${status}`;
        }

        // Update Last Update Time
        function updateLastUpdateTime() {
            lastUpdateTime = new Date();
            if (lastUpdateElement) {
                lastUpdateElement.textContent = lastUpdateTime.toLocaleTimeString('th-TH');
            }
        }

        // Open Tab
        function openTab(tabId) {
            tabButtons.forEach(button => {
                button.classList.toggle('active', button.getAttribute('data-tab') === tabId);
            });
            
            tabContents.forEach(content => {
                content.classList.toggle('active', content.id === tabId);
            });
        }

        // Load Courses
        async function loadCourses() {
            if (!isConnected) return;
            
            try {
                const snapshot = await db.collection('courses').get();
                courses = {};
                snapshot.forEach(doc => {
                    courses[doc.id] = doc.data();
                });
                renderCourses();
            } catch (error) {
                console.error('Error loading courses:', error);
            }
        }

        // Load Bookings
        async function loadBookings() {
            if (!isConnected) return;
            
            try {
                const snapshot = await db.collection('bookings').get();
                bookings = {};
                snapshot.forEach(doc => {
                    bookings[doc.id] = { id: doc.id, ...doc.data() };
                });
            } catch (error) {
                console.error('Error loading bookings:', error);
            }
        }

        // Render Courses
        function renderCourses() {
            coursesList.innerHTML = '';
            
            if (Object.keys(courses).length === 0) {
                coursesList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-book"></i>
                        <h3>ยังไม่มีวิชาในระบบ</h3>
                        <p>กำลังสร้างข้อมูลเริ่มต้น...</p>
                        <div class="loading" style="margin: 20px auto;"></div>
                    </div>
                `;
                return;
            }
            
            for (const courseId in courses) {
                const course = courses[courseId];
                
                let bookedCount = 0;
                for (const bookingId in bookings) {
                    if (bookings[bookingId].courseId === courseId) {
                        bookedCount++;
                    }
                }
                
                const availableSeats = course.totalSeats - bookedCount;
                const percentage = Math.round((bookedCount / course.totalSeats) * 100);
                
                let progressColor = '#34a853';
                if (percentage >= 80) {
                    progressColor = '#000000'; // เปลี่ยนเป็นสีดำเมื่อเต็ม
                } else if (percentage >= 50) {
                    progressColor = '#fbbc04';
                }
                
                const courseCard = document.createElement('div');
                courseCard.className = 'course-card';
                courseCard.innerHTML = `
                    <h3>${course.name}</h3>
                    <p><i class="fas fa-code"></i> <strong>รหัสวิชา:</strong> ${courseId}</p>
                    <p><i class="fas fa-chalkboard-teacher"></i> <strong>อาจารย์:</strong> ${course.instructor || '-'}</p>
                    <p><i class="fas fa-clock"></i> <strong>เวลาเรียน:</strong> ${course.time || '-'}</p>
                    <p><i class="fas fa-info-circle"></i> <strong>คำอธิบาย:</strong> ${course.description || '-'}</p>
                    
                    <div class="seat-progress">
                        <div class="progress-bar" style="width: ${percentage}%; background: ${progressColor};"></div>
                    </div>
                    
                    <div class="seat-info">
                        <span class="available">
                            <i class="fas fa-chair"></i> ว่าง ${availableSeats} ที่นั่ง
                        </span>
                        <span class="booked">
                            <i class="fas fa-user-check"></i> จองแล้ว ${bookedCount} ที่นั่ง
                        </span>
                    </div>
                    
                    <button class="btn select-course" data-course-id="${courseId}">
                        <i class="fas fa-calendar-check"></i> เลือกวิชานี้
                    </button>
                `;
                
                coursesList.appendChild(courseCard);
            }
            
            document.querySelectorAll('.select-course').forEach(button => {
                button.addEventListener('click', function() {
                    selectCourse(this.getAttribute('data-course-id'));
                });
            });
        }

        // Select Course
        function selectCourse(courseId) {
            if (!isConnected) {
                showMessage('ข้อผิดพลาด', 'ไม่สามารถเชื่อมต่อกับฐานข้อมูลได้');
                return;
            }
            
            selectedCourse = courseId;
            const course = courses[courseId];
            
            if (!course) {
                showMessage('ข้อผิดพลาด', 'ไม่พบข้อมูลวิชา');
                return;
            }
            
            courseNameElement.textContent = course.name;
            courseDescriptionElement.textContent = course.description || '';
            courseCodeElement.textContent = courseId;
            courseInstructorElement.textContent = course.instructor || '-';
            courseTimeElement.textContent = course.time || '-';
            totalSeatsCountElement.textContent = course.totalSeats;
            
            bookingTab.disabled = false;
            openTab('booking');
            
            selectedSeats = [];
            selectedSeatsDisplay.textContent = 'ยังไม่มีการเลือกที่นั่ง';
            selectedSeatsDisplay.style.background = '#e8f4ea';
            selectedSeatsDisplay.style.color = '#34a853';
            studentNameInput.value = '';
            studentClassInput.value = '';
            
            clearReservation();
            confirmationBox.classList.remove('active');
            
            renderSeats();
        }

        // Render Seats
        function renderSeats() {
            if (!selectedCourse || !isConnected) return;
            
            const course = courses[selectedCourse];
            if (!course) return;
            
            seatsContainer.innerHTML = '';
            
            let bookedCount = 0;
            const bookedSeats = {};
            
            for (const bookingId in bookings) {
                const booking = bookings[bookingId];
                if (booking.courseId === selectedCourse) {
                    bookedSeats[booking.seatNumber] = {
                        booked: true,
                        studentName: booking.studentName,
                        studentClass: booking.studentClass
                    };
                    bookedCount++;
                }
            }
            
            const reservedSeats = {};
            for (const reservationId in seatReservations) {
                const reservation = seatReservations[reservationId];
                if (reservation.courseId === selectedCourse && reservation.userId !== getUserId()) {
                    reservedSeats[reservation.seatNumber] = {
                        reserved: true,
                        reservedAt: reservation.reservedAt
                    };
                }
            }
            
            const availableSeats = course.totalSeats - bookedCount;
            availableSeatsCountElement.textContent = availableSeats;
            
            for (let i = 1; i <= course.totalSeats; i++) {
                const seat = document.createElement('div');
                seat.className = 'seat';
                seat.textContent = i;
                
                if (bookedSeats[i]) {
                    seat.classList.add('seat-booked');
                    seat.title = `จองแล้วโดย: ${bookedSeats[i].studentName} (${bookedSeats[i].studentClass})`;
                } else if (reservedSeats[i]) {
                    seat.classList.add('seat-reserving');
                    const reservedTime = new Date(reservedSeats[i].reservedAt);
                    const timeDiff = Math.floor((new Date() - reservedTime) / 1000);
                    const timeLeft = RESERVATION_TIMEOUT_SECONDS - timeDiff;
                    seat.title = `กำลังถูกเลือกโดยผู้อื่น (เหลือเวลา ${timeLeft} วินาที)`;
                } else if (selectedSeats.includes(i)) {
                    seat.classList.add('seat-selected');
                    seat.title = 'กำลังเลือก (สีเขียว)';
                } else {
                    seat.classList.add('seat-available');
                    seat.title = 'ที่นั่งว่าง';
                    seat.addEventListener('click', () => selectSeat(i));
                }
                
                seatsContainer.appendChild(seat);
            }
        }

        // Get unique user ID
        function getUserId() {
            let userId = localStorage.getItem('user_id');
            if (!userId) {
                userId = 'user_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('user_id', userId);
            }
            return userId;
        }

        // Select Seat
        async function selectSeat(seatNumber) {
            if (!isConnected) {
                showMessage('ข้อผิดพลาด', 'ไม่สามารถเชื่อมต่อกับฐานข้อมูลได้');
                return;
            }
            
            for (const reservationId in seatReservations) {
                const reservation = seatReservations[reservationId];
                if (reservation.courseId === selectedCourse && 
                    reservation.seatNumber === seatNumber &&
                    reservation.userId !== getUserId()) {
                    
                    const reservedTime = new Date(reservation.reservedAt);
                    const timeDiff = Math.floor((new Date() - reservedTime) / 1000);
                    const timeLeft = RESERVATION_TIMEOUT_SECONDS - timeDiff;
                    
                    if (timeLeft > 0) {
                        showMessage('ไม่สามารถเลือกที่นั่งนี้ได้', 
                            `ที่นั่ง ${seatNumber} กำลังถูกเลือกโดยผู้อื่น\n` +
                            `กรุณารอ ${timeLeft} วินาที หรือเลือกที่นั่งอื่น`
                        );
                        return;
                    }
                }
            }
            
            if (!selectedSeats.includes(seatNumber)) {
                selectedSeats.push(seatNumber);
                
                await createSeatReservation(seatNumber);
                
                updateSelectedSeatsDisplay();
                startReservationTimer();
                
            } else {
                selectedSeats = selectedSeats.filter(num => num !== seatNumber);
                
                await deleteSeatReservation(seatNumber);
                
                updateSelectedSeatsDisplay();
                
                if (selectedSeats.length === 0) {
                    clearReservation();
                }
            }
            
            renderSeats();
        }

        // สร้างการจองชั่วคราว
        async function createSeatReservation(seatNumber) {
            try {
                const reservationId = `${selectedCourse}_${seatNumber}_${getUserId()}`;
                const reservationRef = db.collection('seat_reservations').doc(reservationId);
                
                await reservationRef.set({
                    courseId: selectedCourse,
                    seatNumber: seatNumber,
                    userId: getUserId(),
                    reservedAt: new Date().toISOString(),
                    expiresAt: new Date(Date.now() + RESERVATION_TIMEOUT_SECONDS * 1000).toISOString()
                });
                
            } catch (error) {
                console.error('Error creating seat reservation:', error);
            }
        }

        // ลบการจองชั่วคราว
        async function deleteSeatReservation(seatNumber) {
            try {
                const reservationId = `${selectedCourse}_${seatNumber}_${getUserId()}`;
                await db.collection('seat_reservations').doc(reservationId).delete();
            } catch (error) {
                console.error('Error deleting seat reservation:', error);
            }
        }

        // อัพเดทการแสดงผล
        function updateSelectedSeatsDisplay() {
            if (selectedSeats.length > 0) {
                selectedSeatsDisplay.textContent = selectedSeats.join(', ');
                selectedSeatsDisplay.style.background = '#e8f4ea';
                selectedSeatsDisplay.style.color = '#34a853';
                selectedSeatsDisplay.style.fontWeight = 'bold';
                selectedSeatsDisplay.style.borderColor = '#34a853';
                
                reservationTimeoutElement.style.display = 'flex';
                confirmationBox.classList.add('active');
            } else {
                selectedSeatsDisplay.textContent = 'ยังไม่มีการเลือกที่นั่ง';
                selectedSeatsDisplay.style.background = '#e8f4ea';
                selectedSeatsDisplay.style.color = '#34a853';
                selectedSeatsDisplay.style.fontWeight = 'normal';
                selectedSeatsDisplay.style.borderColor = '#34a853';
                
                reservationTimeoutElement.style.display = 'none';
                confirmationBox.classList.remove('active');
            }
        }

        // เริ่มนับเวลาถอยหลัง
        function startReservationTimer() {
            clearTimeout(reservationTimeout);
            clearInterval(reservationTimer);
            
            let timeLeft = RESERVATION_TIMEOUT_SECONDS;
            timeoutCountdownElement.textContent = timeLeft;
            
            reservationTimer = setInterval(() => {
                timeLeft--;
                timeoutCountdownElement.textContent = timeLeft;
                
                if (timeLeft <= 0) {
                    clearReservation();
                    showMessage('หมดเวลาการจอง', 'เวลาจองที่นั่งหมดอายุแล้ว กรุณาเลือกที่นั่งใหม่');
                }
            }, 1000);
            
            reservationTimeout = setTimeout(() => {
                clearReservation();
            }, RESERVATION_TIMEOUT_SECONDS * 1000);
        }

        // ล้างการจองทั้งหมด
        async function clearReservation() {
            if (selectedCourse) {
                for (const seatNumber of selectedSeats) {
                    await deleteSeatReservation(seatNumber);
                }
            }
            
            selectedSeats = [];
            updateSelectedSeatsDisplay();
            
            clearTimeout(reservationTimeout);
            clearInterval(reservationTimer);
            
            reservationTimeoutElement.style.display = 'none';
            confirmationBox.classList.remove('active');
            
            if (selectedCourse) {
                renderSeats();
            }
        }

        // ฟังก์ชันป้องกันการจองซ้ำ
        async function reserveSeatWithTransaction(courseId, seatNumber, studentName, studentClass, bookingTime, bookingDate) {
            return await db.runTransaction(async (transaction) => {
                const seatCheckQuery = db.collection('bookings')
                    .where('courseId', '==', courseId)
                    .where('seatNumber', '==', seatNumber);
                
                const seatCheckSnapshot = await transaction.get(seatCheckQuery);
                
                if (!seatCheckSnapshot.empty) {
                    throw new Error(`ที่นั่ง ${seatNumber} ถูกจองไปแล้ว`);
                }
                
                const reservationId = `${courseId}_${seatNumber}_${getUserId()}`;
                const reservationRef = db.collection('seat_reservations').doc(reservationId);
                transaction.delete(reservationRef);
                
                const bookingRef = db.collection('bookings').doc();
                transaction.set(bookingRef, {
                    courseId: courseId,
                    seatNumber: seatNumber,
                    studentName: studentName,
                    studentClass: studentClass,
                    bookingTime: bookingTime,
                    bookingDate: bookingDate
                });
                
                return bookingRef.id;
            });
        }

        // Confirm Booking
        async function confirmBooking() {
            if (isProcessingBooking) {
                showMessage('กำลังดำเนินการ', 'กรุณารอสักครู่ กำลังดำเนินการจอง...');
                return;
            }
            
            if (!isConnected) {
                showMessage('ข้อผิดพลาด', 'ไม่สามารถเชื่อมต่อกับฐานข้อมูลได้');
                return;
            }
            
            if (!selectedCourse) {
                showMessage('ข้อผิดพลาด', 'กรุณาเลือกวิชาก่อน');
                return;
            }
            
            if (selectedSeats.length === 0) {
                showMessage('ข้อผิดพลาด', 'กรุณาเลือกที่นั่งก่อน');
                return;
            }
            
            const studentName = studentNameInput.value.trim();
            const studentClass = studentClassInput.value.trim();
            
            if (!studentName) {
                showMessage('ข้อผิดพลาด', 'กรุณากรอกชื่อ-นามสกุล');
                studentNameInput.focus();
                return;
            }
            
            if (!studentClass) {
                showMessage('ข้อผิดพลาด', 'กรุณากรอกห้องเรียน');
                studentClassInput.focus();
                return;
            }
            
            try {
                isProcessingBooking = true;
                confirmBookingBtn.disabled = true;
                confirmBookingBtn.classList.add('btn-disabled');
                
                loadingText.textContent = 'กำลังตรวจสอบที่นั่ง...';
                loadingModal.classList.add('active');
                
                const bookingTime = new Date().toISOString();
                const bookingDate = new Date().toISOString().split('T')[0];
                const bookingIds = [];
                const failedSeats = [];
                
                for (const seatNumber of selectedSeats) {
                    try {
                        loadingText.textContent = `กำลังตรวจสอบที่นั่ง ${seatNumber}...`;
                        
                        const bookingId = await reserveSeatWithTransaction(
                            selectedCourse,
                            seatNumber,
                            studentName,
                            studentClass,
                            bookingTime,
                            bookingDate
                        );
                        
                        bookingIds.push({ seatNumber, bookingId });
                        
                    } catch (error) {
                        console.error(`Error reserving seat ${seatNumber}:`, error);
                        failedSeats.push({
                            seatNumber: seatNumber,
                            error: error.message
                        });
                    }
                }
                
                loadingModal.classList.remove('active');
                
                if (failedSeats.length === 0) {
                    const seatsList = selectedSeats.join(', ');
                    showMessage('สำเร็จ', 
                        `จองที่นั่ง ${seatsList} สำเร็จ!\n\n` +
                        `ชื่อ: ${studentName}\n` +
                        `ห้องเรียน: ${studentClass}\n` +
                        `วิชา: ${selectedCourse}\n` +
                        `หมายเลขการจอง: ${bookingIds[0].bookingId.substring(0, 8)}\n\n` +
                        `โปรดบันทึกข้อมูลนี้ไว้`
                    );
                    
                    clearReservation();
                    studentNameInput.value = '';
                    studentClassInput.value = '';
                    
                    renderCourses();
                    renderSeats();
                    
                } else if (bookingIds.length > 0) {
                    const successSeats = bookingIds.map(b => b.seatNumber).join(', ');
                    const failedSeatsList = failedSeats.map(f => f.seatNumber).join(', ');
                    
                    showMessage('มีบางที่นั่งไม่สำเร็จ', 
                        `จองสำเร็จ: ที่นั่ง ${successSeats}\n` +
                        `ไม่สำเร็จ: ที่นั่ง ${failedSeatsList}\n\n` +
                        `ชื่อ: ${studentName}\n` +
                        `ห้องเรียน: ${studentClass}\n` +
                        `วิชา: ${selectedCourse}\n\n` +
                        `กรุณาลองเลือกที่นั่งอื่นหรือติดต่อผู้ดูแล`
                    );
                    
                    selectedSeats = failedSeats.map(f => f.seatNumber);
                    updateSelectedSeatsDisplay();
                    
                    renderSeats();
                    
                } else {
                    const errorMessages = failedSeats.map(f => `ที่นั่ง ${f.seatNumber}: ${f.error}`).join('\n');
                    showMessage('การจองไม่สำเร็จ', 
                        `ไม่สามารถจองที่นั่งได้:\n\n` +
                        errorMessages + '\n\n' +
                        `กรุณาเลือกที่นั่งใหม่และลองอีกครั้ง`
                    );
                    
                    renderSeats();
                }
                
            } catch (error) {
                console.error('Error in confirmBooking:', error);
                loadingModal.classList.remove('active');
                showMessage('ข้อผิดพลาด', 
                    'เกิดข้อผิดพลาดในการจอง\n\n' +
                    'ข้อผิดพลาด: ' + error.message + '\n\n' +
                    'กรุณาลองใหม่อีกครั้ง'
                );
                
            } finally {
                isProcessingBooking = false;
                confirmBookingBtn.disabled = false;
                confirmBookingBtn.classList.remove('btn-disabled');
            }
        }

        // Show Message
        function showMessage(title, text) {
            messageTitle.textContent = title;
            messageText.innerHTML = text.replace(/\n/g, '<br>');
            messageModal.classList.add('active');
        }

        // Close Message
        function closeMessage() {
            messageModal.classList.remove('active');
        }
    </script>
</body>
</html>
